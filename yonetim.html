<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli | BAKÄ° S2 - Ä°ÅLEVCÄ°L</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --purple: #6c5ce7; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #110915; 
            color: #ffffff;
            min-height: 100vh;
            display: flex; 
        }
        .sidebar {
            background-color: #1a0e21; 
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
            width: 250px;
        }
        .main-content {
            background-color: #110915;
            flex-grow: 1;
        }
        .admin-card {
            background-color: #1a0e21;
            border: 1px solid rgba(108, 92, 231, 0.3);
            border-radius: 0.75rem; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); 
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            text-decoration: none;
            color: #e5e7eb;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .nav-item.active {
            background-color: var(--purple);
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.5);
        }
        .nav-item:hover:not(.active) {
            background-color: rgba(108, 92, 231, 0.1);
            border-radius: 0.5rem;
        }
        #loadingOverlay {
            background-color: #110915; 
            z-index: 1000; 
            display: flex; 
        }
        .admin-table th, .admin-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #2a1b3a;
            text-align: left;
        }
        .log-line { font-family: monospace; font-size: 0.85rem; padding: 0.25rem 0; border-bottom: 1px dotted #2a1b3a; }

        /* Toast Bildirim Stili */
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            background-color: #1a0e21;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px);
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            const adminPanelWrapper = document.getElementById('adminPanelWrapper');
            if (adminPanelWrapper) {
                adminPanelWrapper.classList.remove('hidden');
            }
        });
    </script>
    
    <div id="toast" role="alert">
        <div id="toastContent" class="flex items-center space-x-2"></div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mb-4"></div>
        <p id="loadingMessage" class="text-lg text-white text-center">YÃ¶netici Paneli yÃ¼kleniyor...</p>
    </div>

    <div id="adminPanelWrapper" class="hidden w-full flex">
        
        <div class="sidebar h-screen p-4 flex flex-col">
            <div class="text-3xl font-extrabold text-white mb-8 text-center">
                <i class="fas fa-screwdriver-wrench text-purple-500 mr-1"></i> ULTIMATE
            </div>

            <nav class="flex-grow space-y-2">
                <a href="#" class="nav-item active" data-content="dashboard">
                    <i class="fas fa-chart-line w-6 mr-3"></i> YÃ¶netim Panosu
                </a>
                <a href="#" class="nav-item" data-content="analytics">
                    <i class="fas fa-chart-bar w-6 mr-3"></i> Analizler
                </a>
                <a href="#" class="nav-item" data-content="network">
                    <i class="fas fa-satellite-dish w-6 mr-3"></i> AÄŸ Aktivitesi
                </a>
                <a href="#" class="nav-item" data-content="users">
                    <i class="fas fa-users w-6 mr-3"></i> KullanÄ±cÄ± YÃ¶netimi
                </a>
                <a href="#" class="nav-item" data-content="links">
                    <i class="fas fa-link w-6 mr-3"></i> Link YÃ¶netimi
                </a>
                 <a href="#" class="nav-item" data-content="reports">
                    <i class="fas fa-flag w-6 mr-3"></i> Rapor YÃ¶netimi
                </a>
                <a href="#" class="nav-item" data-content="settings">
                    <i class="fas fa-cogs w-6 mr-3"></i> Sistem AyarlarÄ±
                </a>
            </nav>

            <div class="mt-auto pt-4 border-t border-gray-700">
                <button id="adminLogoutButton" style="display: none;" class="w-full flex items-center justify-center p-3 text-red-400 bg-gray-700 rounded-lg font-semibold hover:bg-red-800 hover:text-white transition duration-200">
                    <i class="fas fa-sign-out-alt mr-3"></i> Ã‡Ä±kÄ±ÅŸ Yap
                </button>
            </div>
        </div>

        <div class="main-content p-8 overflow-y-auto">
            <header class="mb-8 pb-4 border-b border-gray-700">
                <h1 id="pageTitle" class="text-4xl font-extrabold text-white">YÃ¶netim Panosu</h1>
                <p class="text-gray-400">Sistem verilerine hÄ±zlÄ± genel bakÄ±ÅŸ.</p>
            </header>

            <div id="dashboardContent" class="content-tab">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="admin-card p-6">
                        <i class="fas fa-users text-purple-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="totalUsers">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Toplam KullanÄ±cÄ±</p>
                    </div>
                    <div class="admin-card p-6">
                        <i class="fas fa-link text-yellow-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="totalLinks">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Toplam Link</p>
                    </div>
                    <div class="admin-card p-6">
                        <i class="fas fa-check-circle text-green-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="premiumUsers">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Aktif Premium</p>
                    </div>
                    <div class="admin-card p-6">
                        <i class="fas fa-rocket text-red-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="linkClicks">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Toplam TÄ±klama</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Sistem SaÄŸlÄ±ÄŸÄ±</h3>
                        <div class="space-y-2">
                             <p class="text-gray-400 flex justify-between">Firestore Durumu: <span id="firestoreStatus" class="text-yellow-500">Kontrol Ediliyor...</span></p>
                             <p class="text-gray-400 flex justify-between">Cloud Functions: <span class="text-yellow-500">âš ï¸ Gecikmeli (Sim.)</span></p>
                             <p class="text-gray-400 flex justify-between">CDN Ã–n belleÄŸi: <span class="text-green-500">âœ… Ã‡alÄ±ÅŸÄ±yor (Sim.)</span></p>
                        </div>
                    </div>
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Bekleyen Ä°ÅŸlemler</h3>
                        <div class="space-y-2">
                             <p class="text-gray-400 flex justify-between">Ä°ncelenmeyi bekleyen Rapor: <span id="pendingReportsCount" class="text-yellow-400 font-bold">0</span></p>
                             <p class="text-gray-400 flex justify-between">Onay bekleyen Ã–deme: <span class="text-green-400 font-bold">0 (Sim.)</span></p>
                             <p class="text-gray-400 flex justify-between">KullanÄ±cÄ±dan Gelen Mesaj: <span class="text-purple-400 font-bold">0 (Sim.)</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analyticsContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Analizler ve Ä°statistikler <i class="fas fa-chart-bar ml-2 text-blue-400"></i></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">Son 30 GÃ¼nlÃ¼k KayÄ±tlar</h4>
                        <canvas id="userChart"></canvas>
                    </div>
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">En Ã‡ok YÃ¶nlendiren Ãœlkeler</h4>
                        <canvas id="countryChart"></canvas>
                    </div>
                </div>
                <div class="admin-card p-6 mt-6">
                    <h4 class="text-xl font-bold text-white mb-4">En Ã‡ok TÄ±klanan Ä°lk 10 Link</h4>
                    <table class="admin-table w-full text-left">
                        <thead>
                            <tr>
                                <th class="text-purple-400">KÄ±sa URL</th>
                                <th class="text-purple-400">Hedef URL</th>
                                <th class="text-purple-400">TÄ±klama</th>
                            </tr>
                        </thead>
                        <tbody id="topLinksTableBody">
                            <td colspan="3" class="text-center text-gray-500">Veriler yÃ¼kleniyor...</td>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="networkContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">AÄŸ Aktivitesi ve CanlÄ± Loglar <i class="fas fa-satellite-dish ml-2 text-red-400"></i></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">ğŸŒ KÃ¼resel Trafik HaritasÄ± (Sim.)</h4>
                        <div class="h-48 flex items-center justify-center bg-gray-900 rounded-lg border border-purple-500/30">
                            <span class="text-lg text-gray-500">ğŸŒ [KÃ¼resel Harita GÃ¶rÃ¼nÃ¼mÃ¼ API Entegrasyonu]</span>
                        </div>
                    </div>
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">âš¡ CanlÄ± EriÅŸim LoglarÄ± (Sim.)</h4>
                        <div id="liveLogs" class="h-48 overflow-y-scroll bg-gray-900 rounded-lg p-2 border border-yellow-500/30 space-y-1">
                            <div class="log-line text-green-400">[12:30:11] GET /link-a: 200 OK (TR)</div>
                            <div class="log-line text-red-400">[12:30:08] ERROR: Link /banned-code: 403 (US)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="usersContent" class="content-tab hidden">
                 <h3 class="text-2xl font-bold text-white mb-4">KullanÄ±cÄ± YÃ¶netimi <i class="fas fa-user-shield ml-2 text-purple-400"></i></h3>
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ” KullanÄ±cÄ± Arama & Ä°ÅŸlemler</h4>
                    <div class="flex space-x-3 mb-4">
                        <input type="email" id="userSearchEmail" placeholder="KullanÄ±cÄ± E-posta Adresi..." class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                        <button id="searchUserButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-lg">Ara</button>
                    </div>
                    <div id="userSearchResult" class="mt-4 text-gray-300">Arama sonuÃ§larÄ± burada gÃ¶sterilecek.</div>

                    <div id="moderationControls" class="mt-6 pt-4 border-t border-gray-700 space-y-3 hidden">
                        <h5 class="text-lg font-semibold text-white">SeÃ§ili KullanÄ±cÄ±ya Uygulanacak Eylemler</h5>
                         <select id="accountTypeSelect" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                            <option value="BASIC">TEMEL Hesap</option>
                            <option value="PREMIUM">PREMIUM Hesap</option>
                            <option value="ADMIN">YÃ–NETÄ°CÄ° Hesap</option>
                        </select>
                        <button id="updateAccountTypeButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i class="fas fa-check mr-2"></i> Hesap Tipini GÃ¼ncelle (Firestore)
                        </button>
                        <button id="resetPasswordButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i class="fas fa-key mr-2"></i> Åifre SÄ±fÄ±rlama Maili GÃ¶nder (Auth)
                        </button>
                        <button id="banUserButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i class="fas fa-ban mr-2"></i> HesabÄ± KalÄ±cÄ± AskÄ±ya Al (Admin SDK)
                        </button>
                        <p class="text-sm text-yellow-400 mt-2">Bu eylemlerin Ã§oÄŸu, yalnÄ±zca Cloud Functions/Admin SDK ile Ã§alÄ±ÅŸÄ±r.</p>
                    </div>
                </div>
            </div>

            <div id="linksContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Link YÃ¶netimi <i class="fas fa-clipboard-list ml-2 text-yellow-400"></i></h3>
                
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ› ï¸ Link Arama ve Filtreleme</h4>
                     <div class="flex space-x-3 mb-4">
                        <input type="text" id="linkFilter" placeholder="Link (kÄ±sa/hedef) veya KullanÄ±cÄ± E-posta..." class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                        <select id="linkStatusFilter" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                            <option value="all">TÃ¼m Durumlar</option>
                            <option value="active">Aktif</option>
                            <option value="frozen">DondurulmuÅŸ</option>
                            <option value="reported">Raporlu</option>
                        </select>
                         <button id="filterLinksButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg">Filtrele</button>
                    </div>

                    <div id="linksListContainer" class="mt-4">
                        <table class="admin-table w-full text-left">
                            <thead>
                                <tr>
                                    <th class="text-yellow-400">KÄ±sa URL</th>
                                    <th class="text-yellow-400">TÄ±klama</th>
                                    <th class="text-yellow-400">OluÅŸturan</th>
                                    <th class="text-yellow-400">Durum</th>
                                    <th class="text-yellow-400">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="filteredLinksTableBody">
                                <td colspan="5" class="text-center text-gray-500">Filtreleme bekleniyor...</td>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card p-6">
                     <h4 class="text-xl font-bold mb-3">ğŸš¨ Toplu Ä°ÅŸlemler</h4>
                     <button id="bulkFreezeAllButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg mr-3">
                        <i class="fas fa-snowflake mr-2"></i> TÃ¼m Linkleri Dondur (CF Gerekli)
                    </button>
                     <button id="bulkDeleteReportedButton" class="bg-red-800 hover:bg-red-900 text-white font-bold py-3 px-5 rounded-lg">
                        <i class="fas fa-trash mr-2"></i> Raporlu Linkleri Toplu Sil (CF Gerekli)
                    </button>
                </div>
            </div>

            <div id="reportsContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Rapor ve Spam YÃ¶netimi <i class="fas fa-flag ml-2 text-pink-400"></i></h3>
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ“¥ Bekleyen KullanÄ±cÄ± RaporlarÄ± (Sim.)</h4>
                    <div id="pendingReportsList" class="space-y-3">
                        <div class="p-3 bg-gray-700 rounded-lg flex justify-between items-center">
                            <span>**Rapor ID: 001** - Link: /xyz123 (Neden: KÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±m)</span>
                            <div class="space-x-2">
                                <button data-report-id="001" data-action="approve" class="report-action-btn text-green-400 hover:text-green-500 text-sm">Onayla (Link Sil)</button>
                                <button data-report-id="001" data-action="reject" class="report-action-btn text-yellow-400 hover:text-yellow-500 text-sm">Reddet</button>
                            </div>
                        </div>
                        <p class="text-gray-400">Åu anda **3** rapor incelenmeyi bekliyor (Sim.)</p>
                    </div>
                </div>

                <div class="admin-card p-6">
                    <h4 class="text-xl font-bold mb-3">ğŸš« Anahtar Kelime Kara Listesi (Sim.)</h4>
                    <textarea id="blacklistTextarea" rows="3" placeholder="Ã–rnek: phishing.com, spam-site.net, illegal-kelime" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white"></textarea>
                    <button id="saveBlacklistButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg mt-3">Kara Listeyi Kaydet (Sim.)</button>
                </div>
            </div>

            <div id="settingsContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Sistem AyarlarÄ± <i class="fas fa-server ml-2 text-green-400"></i></h3>
                
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ‘· BakÄ±m Modu & Durum (Sim.)</h4>
                    <button id="maintenanceModeToggle" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg transition duration-200">
                        <i class="fas fa-toggle-off mr-2"></i> BakÄ±m Modunu AÃ§
                    </button>
                    <p id="maintenanceStatus" class="mt-3 text-sm text-green-400 hidden">Sistem bakÄ±m modunda.</p>
                </div>

                <div class="admin-card p-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ§¹ Ã–nbellek YÃ¶netimi (Sim.)</h4>
                    <button id="clearCacheButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg mr-3">
                        <i class="fas fa-eraser mr-2"></i> CDN Ã–nbelleÄŸini Temizle
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, fetchSignInMethodsForEmail, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, limit, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js"; // Åu anlÄ±k kullanÄ±lmayacak

        // ***************************************************************
        // KRÄ°TÄ°K NOT: Cloud Functions'Ä± ve Admin SDK'yÄ± kullanmadÄ±ÄŸÄ±mÄ±z
        //             iÃ§in bazÄ± iÅŸlemler SADECE bir simÃ¼lasyon olarak
        //             gÃ¶rev yapacaktÄ±r.
        // ***************************************************************
        
        // Firebase Config ve BaÅŸlatma
        const firebaseConfig = {
            apiKey: "AIzaSyBfc0F8o5aVmwTw-gyLRZVI2OMUljFi6Ao",
            authDomain: "baki-s2-yonetim.firebaseapp.com",
            projectId: "baki-s2-yonetim",
            storageBucket: "baki-s2-yonetim.firebasestorage.app",
            messagingSenderId: "692508919425",
            appId: "1:692508919425:web:fac963c81c11b7be70af80",
            measurementId: "G-Q52XG8GLB2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // const functions = getFunctions(app, "europe-west3"); // Cloud Functions'Ä± ÅŸu anlÄ±k devre dÄ±ÅŸÄ± bÄ±rakÄ±yoruz

        // HTML Elementleri
        const loadingMessage = document.getElementById('loadingMessage');
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const navItems = document.querySelectorAll('.nav-item');
        const contentTabs = document.querySelectorAll('.content-tab');
        const pageTitle = document.getElementById('pageTitle');
        const toast = document.getElementById('toast');
        const toastContent = document.getElementById('toastContent');

        // Ä°ÅŸlevsel Elementler
        const searchUserButton = document.getElementById('searchUserButton');
        const userSearchEmail = document.getElementById('userSearchEmail');
        const moderationControls = document.getElementById('moderationControls');
        const updateAccountTypeButton = document.getElementById('updateAccountTypeButton');
        const resetPasswordButton = document.getElementById('resetPasswordButton');
        const banUserButton = document.getElementById('banUserButton');
        const maintenanceModeToggle = document.getElementById('maintenanceModeToggle');
        const filterLinksButton = document.getElementById('filterLinksButton');
        const bulkFreezeAllButton = document.getElementById('bulkFreezeAllButton');
        const bulkDeleteReportedButton = document.getElementById('bulkDeleteReportedButton');

        // Chart deÄŸiÅŸkenleri
        let userChartInstance = null;
        let countryChartInstance = null;
        
        // Genel DeÄŸiÅŸkenler
        let currentTargetUserUID = null; // GÃ¼ncel iÅŸlem yapÄ±lan kullanÄ±cÄ±nÄ±n UID'sini tutar
        let currentTargetUserEmail = null; // GÃ¼ncel iÅŸlem yapÄ±lan kullanÄ±cÄ±nÄ±n e-postasÄ±nÄ± tutar

        // --- TOAST BÄ°LDÄ°RÄ°MÄ° GÃ–STERME FONKSÄ°YONU ---
        function showToast(message, type = 'success') {
            let icon = '';
            let bgColor = '';
            
            if (type === 'success') { icon = '<i class="fas fa-check-circle text-green-400"></i>'; bgColor = 'bg-green-800/50'; }
            else if (type === 'error') { icon = '<i class="fas fa-times-circle text-red-400"></i>'; bgColor = 'bg-red-800/50'; }
            else { icon = '<i class="fas fa-info-circle text-yellow-400"></i>'; bgColor = 'bg-yellow-800/50'; }

            toastContent.innerHTML = `${icon} <span class="text-white">${message}</span>`;
            toast.className = 'show'; // DiÄŸer sÄ±nÄ±flarÄ± kaldÄ±rmadan sadece show ekle
            
            // Yeniden sÄ±nÄ±flandÄ±rma
            toast.classList.remove('bg-green-800/50', 'bg-red-800/50', 'bg-yellow-800/50');
            toast.classList.add(bgColor);

            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // --- Veri Ã‡ekme Fonksiyonu (YÃ¶netim Panosu) ---
        async function loadDashboardData() {
            try {
                 // Firestore BaÄŸlantÄ± Durumu KontrolÃ¼ (Deneyerek)
                 const testDoc = await getDocs(query(collection(db, "users"), limit(1)));
                 document.getElementById('firestoreStatus').textContent = 'âœ… BaÄŸlÄ±';
                 document.getElementById('firestoreStatus').classList.replace('text-yellow-500', 'text-green-500');

                // Toplam KullanÄ±cÄ± SayÄ±sÄ±
                const usersSnapshot = await getDocs(collection(db, "users"));
                document.getElementById('totalUsers').textContent = usersSnapshot.size.toLocaleString('tr-TR');

                // Toplam Link SayÄ±sÄ±
                const linksSnapshot = await getDocs(collection(db, "links"));
                document.getElementById('totalLinks').textContent = linksSnapshot.size.toLocaleString('tr-TR');
                
                // Aktif Premium KullanÄ±cÄ± SayÄ±sÄ±
                const premiumQuery = query(collection(db, "users"), where("accountType", "==", "PREMIUM"));
                const premiumSnapshot = await getDocs(premiumQuery);
                document.getElementById('premiumUsers').textContent = premiumSnapshot.size.toLocaleString('tr-TR');
                
                // Toplam TÄ±klama SayÄ±sÄ± (VarsayÄ±msal olarak links koleksiyonundan hesaplanÄ±r)
                let totalClicks = 0;
                linksSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.clicks) totalClicks += data.clicks;
                });
                document.getElementById('linkClicks').textContent = (totalClicks + 18500).toLocaleString('tr-TR'); // +18500 simÃ¼lasyon baÅŸlangÄ±Ã§ deÄŸeri

            } catch (e) {
                console.error("YÃ¶netim verileri yÃ¼klenirken hata:", e);
                showToast(`Veri kartlarÄ± yÃ¼klenemedi: Firestore gÃ¼venlik kurallarÄ±nÄ± kontrol edin.`, 'error');
                // Hata durumunda sabit/gÃ¶rÃ¼nÃ¼r deÄŸer gÃ¶ster
                document.getElementById('totalUsers').textContent = 'HATA';
                document.getElementById('totalLinks').textContent = 'HATA';
                document.getElementById('premiumUsers').textContent = 'HATA';
                document.getElementById('linkClicks').textContent = 'HATA';
                document.getElementById('firestoreStatus').textContent = 'âŒ Kural HatasÄ±';
                document.getElementById('firestoreStatus').classList.replace('text-yellow-500', 'text-red-500');
            }
        }
        
        // --- YENÄ° Ã–ZELLÄ°K: Analiz GrafiÄŸi Ã‡izme ---
        function drawAnalyticsCharts() {
            if (userChartInstance) userChartInstance.destroy();
            if (countryChartInstance) countryChartInstance.destroy();
            
            const days = ['H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'H7', 'H8', 'H9', 'H10']; 
            const userCounts = [15, 22, 18, 25, 30, 45, 35, 40, 50, 60];
            const countryData = { 'TÃ¼rkiye': 4500, 'Almanya': 2500, 'ABD': 1500, 'DiÄŸer': 1500 };

            const userCtx = document.getElementById('userChart').getContext('2d');
            userChartInstance = new Chart(userCtx, { type: 'bar', data: { labels: days, datasets: [{ label: 'Yeni KullanÄ±cÄ±lar', data: userCounts, backgroundColor: '#6c5ce7', }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'white' } }, x: { grid: { display: false }, ticks: { color: 'white' } } } } });

            const countryCtx = document.getElementById('countryChart').getContext('2d');
            countryChartInstance = new Chart(countryCtx, { type: 'doughnut', data: { labels: Object.keys(countryData), datasets: [{ data: Object.values(countryData), backgroundColor: ['#6c5ce7', '#ffc107', '#20c997', '#e5e7eb'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } } });
            
            // Top 10 Link Tablosu Doldurma (VarsayÄ±msal)
            const topLinks = [
                { short: '/deneme1', target: 'https://google.com/test', clicks: 1250 },
                { short: '/kampanya', target: 'https://example.com/prom', clicks: 890 },
                { short: '/hizli-link', target: 'https://site.net/fast', clicks: 540 },
                // ... diÄŸer veriler
            ];
            const tableBody = document.getElementById('topLinksTableBody');
            tableBody.innerHTML = '';
            topLinks.forEach(link => {
                tableBody.innerHTML += `<tr><td>${link.short}</td><td>${link.target.substring(0, 30)}...</td><td>${link.clicks}</td></tr>`;
            });
        }
        
        // --- KullanÄ±cÄ± Arama Ä°ÅŸlevi (GerÃ§ekÃ§i) ---
        searchUserButton.addEventListener('click', async () => {
            const email = userSearchEmail.value.trim();
            userSearchResult.innerHTML = 'KullanÄ±cÄ± aranÄ±yor...';
            moderationControls.classList.add('hidden'); 
            currentTargetUserUID = null; 
            currentTargetUserEmail = null;

            if (!email) {
                userSearchResult.innerHTML = '<span class="text-red-400">LÃ¼tfen bir e-posta adresi girin.</span>';
                return;
            }

            try {
                // 1. Auth KontrolÃ¼
                const methods = await fetchSignInMethodsForEmail(auth, email);

                if (methods && methods.length > 0) {
                    // 2. Firestore'dan KullanÄ±cÄ± Verisini Ã‡ek
                    const userQuery = query(collection(db, "users"), where("email", "==", email), limit(1));
                    const userSnap = await getDocs(userQuery);

                    if (!userSnap.empty) {
                        const userData = userSnap.docs[0].data();
                        currentTargetUserUID = userSnap.docs[0].id; 
                        currentTargetUserEmail = email;
                        
                        userSearchResult.innerHTML = `
                            <div class="mt-4 p-4 border border-green-500 rounded-lg bg-gray-800">
                                <h5 class="font-bold text-green-400">KullanÄ±cÄ± Bulundu: ${email}</h5>
                                <p>Hesap Tipi: <span class="font-semibold">${userData.accountType || 'TEMEL'}</span></p>
                                <p>UID: ${currentTargetUserUID}</p>
                            </div>
                        `;
                        moderationControls.classList.remove('hidden');
                        document.getElementById('accountTypeSelect').value = userData.accountType || 'BASIC';

                    } else {
                        userSearchResult.innerHTML = `<span class="text-yellow-400">Auth'da var, ancak Firestore kaydÄ± bulunamadÄ±.</span>`;
                    }
                } else {
                    userSearchResult.innerHTML = `<span class="text-red-400">Bu e-posta adresine kayÄ±tlÄ± bir kullanÄ±cÄ± bulunamadÄ±.</span>`;
                }

            } catch (error) {
                console.error("KullanÄ±cÄ± arama hatasÄ±:", error);
                showToast(`KullanÄ±cÄ± arama hatasÄ±: ${error.message}`, 'error');
            }
        });

        // --- BUTON Ä°ÅLEVSELLÄ°ÄÄ°: Hesap Tipini GÃ¼ncelle (Firestore) ---
        updateAccountTypeButton.addEventListener('click', async () => {
            if (!currentTargetUserUID) {
                showToast("LÃ¼tfen Ã¶nce bir kullanÄ±cÄ± arayÄ±n.", 'info');
                return;
            }

            const newType = document.getElementById('accountTypeSelect').value;

            try {
                const userRef = doc(db, "users", currentTargetUserUID);
                await updateDoc(userRef, {
                    accountType: newType
                });

                showToast(`UID: ${currentTargetUserUID} kullanÄ±cÄ±sÄ±nÄ±n hesap tipi **${newType}** olarak gÃ¼ncellendi.`, 'success');
                searchUserButton.click(); 

            } catch (error) {
                console.error("Hesap tipi gÃ¼ncelleme hatasÄ±:", error);
                showToast(`HATA: Hesap tipi gÃ¼ncellenemedi. Firestore yazma iznini kontrol edin.`, 'error');
            }
        });
        
        // --- BUTON Ä°ÅLEVSELLÄ°ÄÄ°: Åifre SÄ±fÄ±rlama (Auth SDK) ---
        resetPasswordButton.addEventListener('click', async () => {
             if (!currentTargetUserEmail) {
                showToast("LÃ¼tfen Ã¶nce bir kullanÄ±cÄ± arayÄ±n.", 'info');
                return;
            }
            try {
                // Firebase Auth'un tarayÄ±cÄ±dan izin verdiÄŸi tek admin benzeri iÅŸlem budur.
                await sendPasswordResetEmail(auth, currentTargetUserEmail);
                showToast(`E-posta: ${currentTargetUserEmail} adresine ÅŸifre sÄ±fÄ±rlama maili gÃ¶nderildi.`, 'success');
            } catch(e) {
                 showToast(`HATA: Åifre sÄ±fÄ±rlama maili gÃ¶nderilemedi. Yetkilendirme hatasÄ± olabilir.`, 'error');
            }
        });

        // --- BUTON Ä°ÅLEVSELLÄ°ÄÄ°: KullanÄ±cÄ± Yasaklama (Admin SDK Gerekli) ---
        banUserButton.addEventListener('click', async () => {
             if (!currentTargetUserUID) {
                showToast("LÃ¼tfen Ã¶nce bir kullanÄ±cÄ± arayÄ±n.", 'info');
                return;
            }
            if (confirm(`UID: ${currentTargetUserUID} kullanÄ±cÄ±sÄ±nÄ± KALICI olarak yasaklamak istediÄŸinizden emin misiniz? BU Ä°ÅLEM GERÄ° ALINAMAZ.`)) {
                 // Sadece simÃ¼lasyon ve uyarÄ±
                 showToast(`UID: ${currentTargetUserUID} kullanÄ±cÄ±sÄ± iÃ§in yasaklama emri gÃ¶nderildi. (Bu iÅŸlem Cloud Function/Admin SDK gerektirir ve ÅŸu an simÃ¼lasyondur)`, 'info');
            }
        });

        // --- BUTON Ä°ÅLEVSELLÄ°ÄÄ°: Link Filtreleme (GerÃ§ekÃ§i) ---
        filterLinksButton.addEventListener('click', async () => {
            const filterText = document.getElementById('linkFilter').value.trim().toLowerCase();
            const statusFilter = document.getElementById('linkStatusFilter').value;
            
            filteredLinksTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-yellow-500">Linkler filtreleniyor...</td></tr>';

            let linkQuery = collection(db, "links");
            let q;

            try {
                // Durum filtresi (Firestore)
                if (statusFilter !== 'all') {
                    q = query(linkQuery, where("status", "==", statusFilter), limit(50));
                } else {
                    q = query(linkQuery, limit(50));
                }
                
                const linkSnap = await getDocs(q);
                let links = linkSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Metin filtresi (Client-Side)
                if (filterText) {
                    links = links.filter(link => 
                        link.id?.toLowerCase().includes(filterText) ||
                        link.targetUrl?.toLowerCase().includes(filterText) ||
                        link.createdBy?.toLowerCase().includes(filterText)
                    );
                }

                filteredLinksTableBody.innerHTML = '';
                if (links.length === 0) {
                    filteredLinksTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Filtrenize uygun link bulunamadÄ±.</td></tr>';
                    return;
                }

                links.forEach(link => {
                    const statusText = link.status || 'Aktif';
                    const statusClass = statusText === 'reported' ? 'text-red-400' : statusText === 'frozen' ? 'text-yellow-400' : 'text-green-400';
                    filteredLinksTableBody.innerHTML += `
                        <tr>
                            <td>/link/${link.id}</td>
                            <td>${link.clicks || 0}</td>
                            <td>${link.createdBy || 'Bilinmiyor'}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td><button data-link-id="${link.id}" class="link-action-btn text-red-400 hover:text-red-500 text-sm">Dondur</button></td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error("Link filtreleme hatasÄ±:", error);
                filteredLinksTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500">HATA: Veriler Ã§ekilemedi. GÃ¼venlik kurallarÄ±nÄ± kontrol edin.</td></tr>`;
                showToast(`Link filtreleme hatasÄ±: ${error.message}`, 'error');
            }
        });

        // --- TOPLU Ä°ÅLEMLER VE SÄ°MÃœLASYON BUTONLARI ---
        bulkFreezeAllButton.addEventListener('click', () => {
            showToast("TÃ¼m aktif linkler donduruluyor... (Cloud Function gereklidir. SimÃ¼lasyon)", 'info');
        });
        
        bulkDeleteReportedButton.addEventListener('click', () => {
            showToast("Raporlu linkler toplu silme iÅŸlemi baÅŸlatÄ±ldÄ±. (Cloud Function gereklidir. SimÃ¼lasyon)", 'info');
        });

        document.getElementById('saveBlacklistButton').addEventListener('click', () => {
             const blacklistText = document.getElementById('blacklistTextarea').value;
             showToast(`Kara liste ayarlarÄ± (${blacklistText.split(',').length} Ã¶ÄŸe) kaydedildi (SimÃ¼lasyon)`, 'success');
        });
        
        document.getElementById('clearCacheButton').addEventListener('click', () => {
             showToast("CDN Ã¶nbelleÄŸi temizleme gÃ¶revi gÃ¶nderildi. (Sunucu/Cloud Function gereklidir. SimÃ¼lasyon)", 'success');
        });
        
        // Link Dondurma (Tekil Link)
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('link-action-btn')) {
                const linkId = e.target.getAttribute('data-link-id');
                try {
                    // Firestore'da 'status' alanÄ±nÄ± 'frozen' olarak gÃ¼ncelle
                    const linkRef = doc(db, "links", linkId);
                    await updateDoc(linkRef, { status: 'frozen' });
                    showToast(`Link ID: ${linkId} baÅŸarÄ±yla DONDURULDU.`, 'success');
                    // Listeyi yeniden filtrele
                    filterLinksButton.click(); 

                } catch (error) {
                     console.error("Link dondurma hatasÄ±:", error);
                     showToast(`HATA: Link dondurulamadÄ±. Firestore yazma iznini kontrol edin.`, 'error');
                }
            }
            if (e.target.classList.contains('report-action-btn')) {
                 const reportId = e.target.getAttribute('data-report-id');
                 const action = e.target.getAttribute('data-action');
                 showToast(`Rapor ID: ${reportId} iÃ§in "${action === 'approve' ? 'Onayla (Silme)' : 'Reddet'}" eylemi uygulandÄ± (SimÃ¼lasyon)`, 'info');
            }
        });


        // --- Sayfa GeÃ§iÅŸleri (Tab Switching) ---
        const switchTab = (targetContentId) => {
            contentTabs.forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${targetContentId}Content`).classList.remove('hidden');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-content') === targetContentId) {
                    item.classList.add('active');
                }
            });
            
            const titleMap = {
                'dashboard': 'YÃ¶netim Panosu', 'analytics': 'Sistem Analizleri', 'network': 'AÄŸ Aktivitesi',
                'users': 'KullanÄ±cÄ± YÃ¶netimi', 'links': 'Link YÃ¶netimi', 'reports': 'Rapor YÃ¶netimi',
                'settings': 'Sistem AyarlarÄ±'
            };
            pageTitle.textContent = titleMap[targetContentId] || 'YÃ¶netim Paneli';

            if (targetContentId === 'analytics') {
                drawAnalyticsCharts();
            }
            if (targetContentId === 'links') {
                 filterLinksButton.click();
            }
        };

        // --- BaÅŸlatma ---
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('dashboard'); 

            onAuthStateChanged(auth, (user) => {
                if (user) {
                   document.getElementById('adminLogoutButton').style.display = 'flex';
                } else {
                   // Oturum yoksa, Ã§Ä±kÄ±ÅŸ butonunu gizle
                   document.getElementById('adminLogoutButton').style.display = 'none';
                }
            });
           
            loadDashboardData(); 
        });

    </script>
</body>
</html>
