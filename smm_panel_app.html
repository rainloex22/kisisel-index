<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Kapsamlı SMM Panel | Gemini Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* TEMA RENKLERİ VE GENEL STİL */
        :root {
            --primary-color: #3b82f6; /* Mavi Vurgu */
            --primary-light: #60a5fa;
            --bg-body: #f3f4f6;       /* Açık Gri Arka Plan */
            --bg-card: #ffffff;       /* Kart Arka Planı */
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
        }

        /* Navigasyon Aktifliği için özel stil */
        .nav-item.active {
            background-color: var(--primary-color);
            color: var(--bg-card);
        }

        /* Tailwind sınıflarını özelleştirenler */
        .card {
            background-color: var(--bg-card);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }
        
        .spinner {
            border-top-color: var(--primary-color);
        }

        /* Responsive Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            transition: transform 0.3s ease-in-out;
            transform: translateX(0); /* Default: visible on large screens */
        }
        
        #content-area {
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease-in-out;
        }

        @media (max-width: 1024px) {
            #sidebar {
                transform: translateX(-100%); /* Default: hidden on mobile */
                position: fixed;
                z-index: 50;
                height: 100vh;
            }
            #sidebar.open {
                transform: translateX(0); /* Visible when opened */
            }
            #content-area {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Ana Uygulama Konteyneri -->
    <div id="app" class="flex min-h-screen">

        <!-- Sidebar - Sadece Yetkili Kullanıcılar İçin -->
        <aside id="sidebar" class="bg-gray-800 text-white p-6 shadow-xl lg:block" style="z-index: 50;">
            <div class="flex justify-between items-center mb-10">
                <h1 class="text-2xl font-extrabold text-blue-400">GEMINI PANEL</h1>
                <!-- Mobil kapatma butonu -->
                <button id="close-sidebar-btn" class="lg:hidden text-gray-400 hover:text-white text-xl" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Kullanıcı Bilgisi -->
            <div id="user-info-sidebar" class="mb-8 p-3 bg-gray-700 rounded-lg hidden">
                <p class="text-sm font-semibold truncate" id="user-display-name">Kullanıcı: Yükleniyor...</p>
                <p class="text-xs text-gray-400 font-mono break-all" id="user-id">ID: ...</p>
                <p class="text-xs text-yellow-400 mt-1" id="admin-status"></p>
            </div>

            <!-- Navigasyon Menüsü -->
            <nav id="main-nav">
                <ul class="space-y-2">
                    <!-- Navigasyon öğeleri JavaScript ile oluşturulacak -->
                </ul>
            </nav>
        </aside>

        <!-- Ana İçerik Alanı -->
        <main id="content-area" class="flex-grow p-4 lg:p-10">
            
            <!-- Mobile Menu Button and Header -->
            <header class="mb-6 flex justify-between items-center lg:hidden">
                <h1 class="text-xl font-bold text-gray-800">Gemini Panel</h1>
                <button id="open-sidebar-btn" class="text-gray-600 hover:text-gray-900 text-2xl" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </header>
            
            <!-- Global Uyarı Kutusu -->
            <div id="alert-box" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

            <!-- Sayfa İçerikleri (SPA View Containers) -->
            <div id="page-containers">
                <!-- 1. Login Page -->
                <section id="login" class="flex justify-center items-center h-full min-h-[500px] hidden">
                    <div class="card p-8 rounded-xl w-full max-w-md">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6"><i class="fas fa-sign-in-alt mr-2"></i> Giriş Yap</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                                <input type="email" id="login-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-6">
                                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Şifre</label>
                                <input type="password" id="login-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="btn-primary w-full p-3 rounded-lg text-white font-semibold">
                                <span id="login-btn-text">Giriş</span>
                                <div id="login-spinner" class="spinner w-5 h-5 border-2 border-dashed rounded-full animate-spin hidden mx-auto"></div>
                            </button>
                        </form>
                        <div class="mt-4 text-center text-sm space-y-2">
                            <a href="#" onclick="handleNavigation('forgotPassword'); return false;" class="text-blue-500 hover:underline">Şifremi Unuttum</a>
                            <p class="text-gray-600">Hesabınız yok mu? <a href="#" onclick="handleNavigation('register'); return false;" class="text-blue-500 font-semibold hover:underline">Kayıt Olun</a></p>
                        </div>
                    </div>
                </section>

                <!-- 2. Register Page -->
                <section id="register" class="flex justify-center items-center h-full min-h-[500px] hidden">
                    <div class="card p-8 rounded-xl w-full max-w-md">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6"><i class="fas fa-user-plus mr-2"></i> Yeni Hesap Oluştur</h2>
                        <form id="register-form">
                            <div class="mb-4">
                                <label for="displayName" class="block text-sm font-medium text-gray-700 mb-1">Kullanıcı Adı</label>
                                <input type="text" id="displayName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                                <input type="email" id="register-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-6">
                                <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Şifre (Min. 6 Karakter)</label>
                                <input type="password" id="register-password" required minlength="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="btn-primary w-full p-3 rounded-lg text-white font-semibold">
                                <span id="register-btn-text">Kayıt Ol</span>
                                <div id="register-spinner" class="spinner w-5 h-5 border-2 border-dashed rounded-full animate-spin hidden mx-auto"></div>
                            </button>
                        </form>
                        <div class="mt-4 text-center text-sm">
                            <p class="text-gray-600">Zaten hesabınız var mı? <a href="#" onclick="handleNavigation('login'); return false;" class="text-blue-500 font-semibold hover:underline">Giriş Yap</a></p>
                        </div>
                    </div>
                </section>

                <!-- 3. Forgot Password Page -->
                <section id="forgotPassword" class="flex justify-center items-center h-full min-h-[500px] hidden">
                    <div class="card p-8 rounded-xl w-full max-w-md">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6"><i class="fas fa-lock mr-2"></i> Şifremi Unuttum</h2>
                        <form id="forgot-password-form">
                            <div class="mb-6">
                                <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-1">E-posta Adresi</label>
                                <input type="email" id="reset-email" required placeholder="Hesabınıza kayıtlı e-posta adresiniz" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="btn-primary w-full p-3 rounded-lg text-white font-semibold">
                                <span id="reset-btn-text">Şifre Sıfırlama Bağlantısı Gönder</span>
                                <div id="reset-spinner" class="spinner w-5 h-5 border-2 border-dashed rounded-full animate-spin hidden mx-auto"></div>
                            </button>
                        </form>
                        <div class="mt-4 text-center text-sm">
                            <a href="#" onclick="handleNavigation('login'); return false;" class="text-blue-500 hover:underline">Giriş sayfasına geri dön</a>
                        </div>
                    </div>
                </section>

                <!-- 4. New Order / Dashboard Page (Authenticated) -->
                <section id="newOrder" class="hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Yeni Sipariş Ver</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- Order Form -->
                        <div class="lg:col-span-2 card p-6 rounded-xl">
                            <form id="order-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Platform Select -->
                                    <div>
                                        <label for="platformSelect" class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                                        <select id="platformSelect" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="" disabled selected>Platform Seçiniz</option>
                                        </select>
                                    </div>
                                    <!-- Category Select -->
                                    <div>
                                        <label for="categorySelect" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                                        <select id="categorySelect" required disabled class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="" disabled selected>Önce Platform Seçiniz</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Service Type Select -->
                                <div class="mb-4">
                                    <label for="serviceTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Servis Tipi</label>
                                    <select id="serviceTypeSelect" required disabled class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="" disabled selected>Önce Kategori Seçiniz</option>
                                    </select>
                                </div>
                                
                                <!-- Link Input -->
                                <div class="mb-4">
                                    <label for="link" class="block text-sm font-medium text-gray-700 mb-1">Hedef Link</label>
                                    <input type="url" id="link" required placeholder="https://instagram.com/gonderi_linki" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <!-- Quantity Input -->
                                    <div>
                                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Miktar (Min 100)</label>
                                        <input type="number" id="quantity" required min="100" value="1000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <!-- Price per 1000 -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">1000 Adet Fiyatı (₺)</label>
                                        <p id="price-per-k" class="w-full p-3 bg-gray-100 rounded-lg text-gray-600 font-mono">0.00 ₺</p>
                                    </div>
                                    <!-- Total Cost -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Toplam Maliyet (₺)</label>
                                        <p id="total-cost" class="w-full p-3 bg-blue-50 text-blue-700 rounded-lg font-bold">0.00 ₺</p>
                                    </div>
                                </div>
                                
                                <!-- Submit Button -->
                                <button type="submit" id="order-submit-btn" class="btn-primary w-full p-3 rounded-lg text-white font-semibold flex items-center justify-center">
                                    <span id="order-btn-text">Siparişi Onayla ve Oluştur</span>
                                    <div id="order-spinner" class="spinner w-5 h-5 border-2 border-dashed rounded-full animate-spin hidden ml-2"></div>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Panel Info Card -->
                        <div class="lg:col-span-1 card p-6 rounded-xl h-fit">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Panel Bilgileri</h3>
                            <ul class="space-y-3 text-gray-600">
                                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i> Anlık İşlem Başlatma</li>
                                <li class="flex items-center"><i class="fas fa-chart-line text-green-500 mr-3"></i> Garantili Takipçi & Beğeni</li>
                                <li class="flex items-center"><i class="fas fa-users text-green-500 mr-3"></i> 7/24 Canlı Destek (Simülasyon)</li>
                                <li class="flex items-center"><i class="fas fa-credit-card text-green-500 mr-3"></i> Güvenli Ödeme Altyapısı</li>
                            </ul>
                            <a href="https://discord.gg/invite" target="_blank" class="block mt-6 btn-primary p-3 rounded-lg text-white text-center font-semibold bg-indigo-600 hover:bg-indigo-700">
                                <i class="fab fa-discord mr-2"></i> Discord Sunucumuza Katıl
                            </a>
                        </div>
                    </div>
                </section>

                <!-- 5. Order History Page (Authenticated) -->
                <section id="orderHistory" class="hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Sipariş Geçmişi</h2>
                    <div class="card p-6 rounded-xl">
                        <div id="loading-history" class="text-center py-8 text-gray-500">
                            <div class="spinner w-8 h-8 border-4 border-dashed rounded-full animate-spin mx-auto mb-3"></div>
                            Siparişleriniz yükleniyor...
                        </div>
                        <div id="orders-list" class="space-y-4">
                            <!-- Siparişler buraya yüklenecek -->
                        </div>
                        <p id="no-orders" class="text-center py-8 text-gray-500 hidden">Henüz oluşturulmuş bir siparişiniz bulunmamaktadır.</p>
                    </div>
                </section>
                
                <!-- 6. Support Panel Page (Authenticated) -->
                <section id="support" class="hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Destek Sistemi</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- New Ticket Form -->
                        <div class="lg:col-span-1 card p-6 rounded-xl h-fit">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Yeni Destek Talebi</h3>
                            <form id="ticket-form">
                                <div class="mb-4">
                                    <label for="ticketSubject" class="block text-sm font-medium text-gray-700 mb-1">Konu</label>
                                    <input type="text" id="ticketSubject" required placeholder="Sipariş, Ödeme, Hata vb." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="mb-6">
                                    <label for="ticketMessage" class="block text-sm font-medium text-gray-700 mb-1">Detaylı Mesaj</label>
                                    <textarea id="ticketMessage" required rows="4" placeholder="Sipariş ID'si (varsa) ve sorununuzu detaylıca açıklayınız." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <button type="submit" id="ticket-submit-btn" class="btn-primary w-full p-3 rounded-lg text-white font-semibold flex items-center justify-center">
                                    <span id="ticket-btn-text">Talep Oluştur</span>
                                    <div id="ticket-spinner" class="spinner w-5 h-5 border-2 border-dashed rounded-full animate-spin hidden ml-2"></div>
                                </button>
                            </form>
                        </div>

                        <!-- Ticket History -->
                        <div class="lg:col-span-2 card p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Açık Destek Talepleriniz</h3>
                             <div id="loading-tickets" class="text-center py-8 text-gray-500">
                                <div class="spinner w-8 h-8 border-4 border-dashed rounded-full animate-spin mx-auto mb-3"></div>
                                Talepleriniz yükleniyor...
                            </div>
                            <div id="tickets-list" class="space-y-4">
                                <!-- Destek talepleri buraya yüklenecek -->
                            </div>
                            <p id="no-tickets" class="text-center py-8 text-gray-500 hidden">Açık bir destek talebiniz bulunmamaktadır.</p>
                        </div>
                    </div>
                </section>
                
                <!-- 7. Admin Panel Page (Authenticated, Admin only) -->
                <section id="adminPanel" class="hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6"><i class="fas fa-lock text-red-500 mr-2"></i> Yönetici Paneli</h2>
                    <div class="card p-6 rounded-xl bg-red-50 border border-red-200">
                        <p class="text-red-700 font-semibold mb-4">Bu panel, simülasyon amaçlıdır. Gerçek yetkilendirme Firebase Güvenlik Kuralları ile yapılmalıdır.</p>
                        <div id="admin-info" class="space-y-4">
                            
                            <h3 class="text-xl font-bold text-red-800 border-b pb-2 mb-3">Tüm Siparişler</h3>
                            <div id="all-orders-list" class="space-y-3">
                                <p class="text-gray-500">Tüm siparişler listeleniyor...</p>
                                <!-- Tüm siparişler buraya yüklenecek -->
                            </div>
                            
                            <h3 class="text-xl font-bold text-red-800 border-b pb-2 mb-3 mt-8">Açık Destek Talepleri</h3>
                            <div id="all-tickets-list" class="space-y-3">
                                <p class="text-gray-500">Tüm açık talepler listeleniyor...</p>
                                <!-- Tüm açık talepler buraya yüklenecek -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Loading Overlay -->
                <section id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-70 flex justify-center items-center flex-col z-40">
                    <div class="spinner w-12 h-12 border-4 border-dashed rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-700 font-semibold">Uygulama Yükleniyor...</p>
                </section>
            </div>
        </main>
    </div>

    <!-- Custom Message Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-200">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-body" class="text-gray-600 mb-4"></p>
            <button id="modal-close-btn" class="btn-primary w-full p-3 rounded-lg text-white font-semibold">Tamam</button>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('Debug');

        // --- GLOBAL CONFIGURATION (MANDATORY - Canvas Variablesını Kullanın) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-smmgo-app-id';
        
        // __firebase_config'i JSON olarak ayrıştırma (HATANIN KAYNAĞI BURASIYDI)
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigString);
        
        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Simülasyon Yönetici E-postası
        const ADMIN_EMAIL = "admin@smmgo.com"; 

        let db, auth;
        let appState = {
            currentUser: null,
            currentUserId: null,
            currentPage: 'login', // Varsayılan başlangıç sayfası
            isAdmin: false,
        };
        let isFirebaseInitialized = false;

        // --- UI ELEMANLARI ---
        const pageContainers = document.querySelectorAll('#page-containers section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const orderForm = document.getElementById('order-form');
        const ticketForm = document.getElementById('ticket-form');
        const sidebar = document.getElementById('sidebar');
        const contentArea = document.getElementById('content-area');
        const userInfoSidebar = document.getElementById('user-info-sidebar');
        const mainNavUl = document.querySelector('#main-nav ul');
        const loadingOverlay = document.getElementById('loading-overlay');
        const alertBox = document.getElementById('alert-box');

        // --- SMM DATA & UTILS ---
        const SERVICES_DATA = {
            "Instagram": {
                "Takipçi": [
                    { name: "Takipçi (Hızlı - Max 5K)", price: 1.5, id: "ig-f-hizli" },
                    { name: "Takipçi (Garantili - Max 100K)", price: 3.2, id: "ig-f-garantili" }
                ],
                "Beğeni": [
                    { name: "Beğeni (Türk Hesaplar)", price: 0.8, id: "ig-l-turk" },
                    { name: "Beğeni (Global Hızlı)", price: 0.5, id: "ig-l-global" }
                ],
            },
            "TikTok": {
                "Takipçi": [
                    { name: "Takipçi (Global)", price: 1.2, id: "tt-f-global" }
                ],
                "İzlenme": [
                    { name: "İzlenme (Hızlı Başlangıç)", price: 0.2, id: "tt-v-hizli" }
                ]
            },
            "YouTube": {
                "Abone": [
                    { name: "Abone (Garantili)", price: 5.0, id: "yt-s-garantili" }
                ],
                "İzlenme": [
                    { name: "İzlenme (Yüksek Retain)", price: 1.0, id: "yt-v-yuksek" }
                ]
            }
        };
        
        // --- CUSTOM MODAL & ALERT ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        });

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function showAlert(message, type = 'success') {
            alertBox.textContent = message;
            alertBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (type === 'error') {
                alertBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                alertBox.classList.add('bg-green-100', 'text-green-700');
            }
            
            setTimeout(() => alertBox.classList.add('hidden'), 5000);
        }

        // --- FIREBASE COLLECTION REFERENCES ---
        function getCollectionRef(path) {
             // Private Path: /artifacts/{appId}/users/{userId}/{collectionName}
             // Public Path: /artifacts/{appId}/public/data/{collectionName} (Admin için)
            if (path === 'orders') {
                return collection(db, `artifacts/${appId}/users/${appState.currentUserId}/orders`);
            } else if (path === 'tickets') {
                 return collection(db, `artifacts/${appId}/users/${appState.currentUserId}/tickets`);
            } else if (path === 'allOrders') {
                // Not the best practice, but for single-file simulation we use a public collection
                return collection(db, `artifacts/${appId}/public/data/all_orders`);
            } else if (path === 'allTickets') {
                return collection(db, `artifacts/${appId}/public/data/all_tickets`);
            }
        }

        // --- AUTHENTICATION HANDLERS ---
        async function handleRegister(email, password, displayName) {
            const btn = document.getElementById('register-submit-btn');
            const spinner = document.getElementById('register-spinner');
            const btnText = document.getElementById('register-btn-text');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Kullanıcı adını ayarlamak için updateProfile kullanılabilir
                // await updateProfile(userCredential.user, { displayName: displayName });

                showAlert(`Kayıt başarılı! Hoş geldiniz, ${displayName}.`, 'success');
                handleNavigation('newOrder'); // Başarılı kayıttan sonra sipariş sayfasına yönlendir
            } catch (error) {
                console.error("Kayıt hatası:", error);
                const errorMessage = error.code === 'auth/email-already-in-use' ? 'Bu e-posta zaten kullanımda.' : 'Kayıt başarısız oldu. Lütfen tekrar deneyin.';
                showAlert(errorMessage, 'error');
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        async function handleLogin(email, password) {
            const btn = document.getElementById('login-submit-btn');
            const spinner = document.getElementById('login-spinner');
            const btnText = document.getElementById('login-btn-text');

            btn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAlert("Giriş başarılı! Yönlendiriliyorsunuz...", 'success');
                // onAuthStateChanged tetiklenecek ve yönlendirme yapacak
            } catch (error) {
                console.error("Giriş hatası:", error);
                const errorMessage = error.code === 'auth/invalid-credential' ? 'Geçersiz e-posta veya şifre.' : 'Giriş başarısız oldu. Lütfen tekrar deneyin.';
                showAlert(errorMessage, 'error');
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        async function handleForgotPassword(email) {
            const btn = document.getElementById('reset-submit-btn');
            const spinner = document.getElementById('reset-spinner');
            const btnText = document.getElementById('reset-btn-text');

            btn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                await sendPasswordResetEmail(auth, email);
                showModal("E-posta Gönderildi", `Şifrenizi sıfırlamak için bir bağlantı ${email} adresine gönderildi. Lütfen gelen kutunuzu kontrol edin.`);
                handleNavigation('login');
            } catch (error) {
                console.error("Şifre sıfırlama hatası:", error);
                const errorMessage = error.code === 'auth/user-not-found' ? 'Bu e-posta adresine kayıtlı bir kullanıcı bulunamadı.' : 'Sıfırlama başarısız oldu. Konsolu kontrol edin.';
                showAlert(errorMessage, 'error');
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        function handleLogout() {
            signOut(auth).then(() => {
                showAlert("Çıkış yapıldı.", 'success');
                handleNavigation('login');
            }).catch((error) => {
                console.error("Çıkış hatası:", error);
                showAlert("Çıkış yapılırken bir hata oluştu.", 'error');
            });
        }
        
        // --- FIREBASE INITIALIZATION & AUTH LISTENER ---
        async function initializeFirebase() {
            loadingOverlay.classList.remove('hidden');
            
            // Eğer Firebase yapılandırması boşsa, uygulamanın çalışmayacağını belirt
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase başlatma hatası: Global __firebase_config bulunamadı veya boş.");
                 loadingOverlay.classList.add('hidden');
                 showModal("Hata", "Uygulama başlatılamadı. Firebase yapılandırması eksik.");
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseInitialized = true;

                // Canvas ortamında otomatik auth token kullanma (ÖNCELİK!)
                if (customToken) {
                    await signInWithCustomToken(auth, customToken);
                    console.log("Custom token ile oturum açıldı.");
                } else {
                    // Token yoksa anonim oturum aç (Yedek)
                    await signInAnonymously(auth);
                    console.log("Anonim olarak oturum açıldı.");
                }

                // Auth durumu değişimini izle
                onAuthStateChanged(auth, (user) => {
                    loadingOverlay.classList.add('hidden');
                    if (user) {
                        appState.currentUser = user;
                        appState.currentUserId = user.uid;
                        appState.isAdmin = user.email === ADMIN_EMAIL;
                        
                        // Kullanıcı bilgilerini güncelle
                        document.getElementById('user-display-name').textContent = user.displayName || user.email;
                        // Kullanıcı ID'sinin tamamını göster (Diğer kullanıcıların bulması için önemli)
                        document.getElementById('user-id').textContent = `ID: ${user.uid}`; 
                        document.getElementById('admin-status').textContent = appState.isAdmin ? 'Yönetici' : 'Müşteri';
                        
                        userInfoSidebar.classList.remove('hidden');

                        // Yetkili sayfaya yönlendir, varsayılan 'newOrder'
                        if (['login', 'register', 'forgotPassword'].includes(appState.currentPage)) {
                            handleNavigation('newOrder');
                        } else {
                            handleNavigation(appState.currentPage); // Mevcut sayfada kal
                        }

                    } else {
                        // Kullanıcı yoksa, kimlik doğrulama sayfalarına yönlendir
                        appState.currentUser = null;
                        appState.currentUserId = null;
                        appState.isAdmin = false;
                        userInfoSidebar.classList.add('hidden');
                        handleNavigation('login'); 
                    }
                    updateUI();
                });
            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                loadingOverlay.classList.add('hidden');
                showModal("Hata", `Uygulama başlatılamadı. Hata: ${error.message}`);
            }
        }
        
        // --- DYNAMIC FORM LOGIC (Sipariş Sayfası) ---
        const platformSelect = document.getElementById('platformSelect');
        const categorySelect = document.getElementById('categorySelect');
        const serviceTypeSelect = document.getElementById('serviceTypeSelect');
        const quantityInput = document.getElementById('quantity');
        
        // Platformları doldur
        platformSelect.innerHTML = '<option value="" disabled selected>Platform Seçiniz</option>';
        Object.keys(SERVICES_DATA).forEach(platform => {
            const option = document.createElement('option');
            option.value = platform;
            option.textContent = platform;
            platformSelect.appendChild(option);
        });

        // Kategori ve Servis Seçimlerini Güncelleme
        platformSelect.addEventListener('change', () => {
            const selectedPlatform = platformSelect.value;
            const categories = SERVICES_DATA[selectedPlatform] || {};

            categorySelect.innerHTML = '<option value="" disabled selected>Kategori Seçiniz</option>';
            serviceTypeSelect.innerHTML = '<option value="" disabled selected>Önce Kategori Seçiniz</option>';
            
            categorySelect.disabled = Object.keys(categories).length === 0;
            serviceTypeSelect.disabled = true;

            Object.keys(categories).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            updateCost();
        });

        categorySelect.addEventListener('change', () => {
            const selectedPlatform = platformSelect.value;
            const selectedCategory = categorySelect.value;
            const services = SERVICES_DATA[selectedPlatform]?.[selectedCategory] || [];
            
            serviceTypeSelect.innerHTML = '<option value="" disabled selected>Servis Tipi Seçiniz</option>';
            serviceTypeSelect.disabled = services.length === 0;

            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name}`;
                option.dataset.price = service.price; // 1000 adet fiyatı
                serviceTypeSelect.appendChild(option);
            });
            updateCost();
        });

        serviceTypeSelect.addEventListener('change', updateCost);
        quantityInput.addEventListener('input', updateCost);

        function updateCost() {
            const pricePerKElement = document.getElementById('price-per-k');
            const totalCostElement = document.getElementById('total-cost');
            
            const serviceOption = serviceTypeSelect.options[serviceTypeSelect.selectedIndex];
            const pricePerK = serviceOption && serviceOption.dataset.price ? parseFloat(serviceOption.dataset.price) : 0;
            const quantity = parseInt(quantityInput.value, 10) || 0;

            pricePerKElement.textContent = `${pricePerK.toFixed(2)} ₺`;

            if (pricePerK > 0 && quantity >= 100) {
                const totalCost = (quantity / 1000) * pricePerK;
                totalCostElement.textContent = `${totalCost.toFixed(2)} ₺`;
            } else {
                totalCostElement.textContent = '0.00 ₺';
            }
        }
        
        // --- FIRESTORE OPERATIONS ---

        // 1. Save New Order
        async function saveOrder(orderData) {
            if (!appState.currentUserId) return; // Auth check

            try {
                // 1. Kullanıcının özel koleksiyonuna kaydet
                const orderRef = await addDoc(getCollectionRef('orders'), {
                    ...orderData,
                    status: 'Beklemede',
                    createdAt: serverTimestamp(),
                    userId: appState.currentUserId,
                    userName: appState.currentUser.displayName || appState.currentUser.email,
                });
                
                // 2. Yönetici için genel koleksiyona kopyala (Admin simülasyonu için)
                await addDoc(getCollectionRef('allOrders'), {
                    ...orderData,
                    status: 'Beklemede',
                    createdAt: serverTimestamp(),
                    userId: appState.currentUserId,
                    orderId: orderRef.id, // Referans ID
                    userName: appState.currentUser.displayName || appState.currentUser.email,
                });
                
                showAlert(`Siparişiniz (${orderRef.id}) başarıyla oluşturuldu!`, 'success');
                orderForm.reset(); 
                platformSelect.dispatchEvent(new Event('change')); // Formu sıfırla
            } catch (error) {
                console.error("Sipariş oluşturulurken hata:", error);
                showModal("Hata", `Sipariş oluşturulamadı. Detay: ${error.message}`);
            }
        }
        
        // 2. Save New Ticket
        async function saveTicket(ticketData) {
            if (!appState.currentUserId) return; 

            try {
                // 1. Kullanıcının özel koleksiyonuna kaydet
                const ticketRef = await addDoc(getCollectionRef('tickets'), {
                    ...ticketData,
                    status: 'Açık',
                    createdAt: serverTimestamp(),
                    userId: appState.currentUserId,
                    userName: appState.currentUser.displayName || appState.currentUser.email,
                });

                // 2. Yönetici için genel koleksiyona kopyala
                 await addDoc(getCollectionRef('allTickets'), {
                    ...ticketData,
                    status: 'Açık',
                    createdAt: serverTimestamp(),
                    userId: appState.currentUserId,
                    ticketId: ticketRef.id,
                    userName: appState.currentUser.displayName || appState.currentUser.email,
                });
                
                showAlert(`Destek talebi (${ticketRef.id}) başarıyla oluşturuldu!`, 'success');
                ticketForm.reset(); 
            } catch (error) {
                console.error("Talep oluşturulurken hata:", error);
                showModal("Hata", `Talep oluşturulamadı. Detay: ${error.message}`);
            }
        }

        // 3. Load User Orders (Real-time Listener)
        function loadUserOrders() {
            if (!appState.currentUserId) return;
            const ordersList = document.getElementById('orders-list');
            const loadingHistory = document.getElementById('loading-history');
            const noOrders = document.getElementById('no-orders');
            
            loadingHistory.classList.remove('hidden');
            ordersList.innerHTML = '';
            
            const ordersQuery = query(getCollectionRef('orders'));

            onSnapshot(ordersQuery, (snapshot) => {
                const orders = [];
                snapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });

                orders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); // Newest first

                ordersList.innerHTML = '';
                if (orders.length === 0) {
                    noOrders.classList.remove('hidden');
                } else {
                    noOrders.classList.add('hidden');
                    orders.forEach(order => ordersList.appendChild(createOrderElement(order)));
                }
                loadingHistory.classList.add('hidden');
            }, (error) => {
                console.error("Siparişleri çekerken hata:", error);
                loadingHistory.textContent = 'Siparişler yüklenemedi.';
            });
        }
        
        // 4. Load User Tickets (Real-time Listener)
        function loadUserTickets() {
            if (!appState.currentUserId) return;
            const ticketsList = document.getElementById('tickets-list');
            const loadingTickets = document.getElementById('loading-tickets');
            const noTickets = document.getElementById('no-tickets');

            loadingTickets.classList.remove('hidden');
            ticketsList.innerHTML = '';
            
            const ticketsQuery = query(getCollectionRef('tickets'));

            onSnapshot(ticketsQuery, (snapshot) => {
                const tickets = [];
                snapshot.forEach((doc) => {
                    tickets.push({ id: doc.id, ...doc.data() });
                });

                tickets.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); // Newest first

                ticketsList.innerHTML = '';
                if (tickets.length === 0) {
                    noTickets.classList.remove('hidden');
                } else {
                    noTickets.classList.add('hidden');
                    tickets.forEach(ticket => ticketsList.appendChild(createTicketElement(ticket)));
                }
                loadingTickets.classList.add('hidden');
            }, (error) => {
                console.error("Talepleri çekerken hata:", error);
                loadingTickets.textContent = 'Talepler yüklenemedi.';
            });
        }
        
        // 5. Load Admin Data (One-time fetch for simplicity)
        async function loadAdminData() {
            if (!appState.isAdmin) return;

            // Tüm Siparişler
            const allOrdersList = document.getElementById('all-orders-list');
            allOrdersList.innerHTML = '<p class="text-gray-500">Tüm siparişler yükleniyor...</p>';
            try {
                const allOrdersSnapshot = await getDocs(getCollectionRef('allOrders'));
                const allOrders = [];
                allOrdersSnapshot.forEach(doc => allOrders.push({ id: doc.id, ...doc.data() }));
                
                allOrders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                allOrdersList.innerHTML = '';
                if (allOrders.length === 0) {
                    allOrdersList.textContent = 'Sistemde hiç sipariş yok.';
                } else {
                    allOrders.forEach(order => allOrdersList.appendChild(createAdminOrderElement(order)));
                }
            } catch (error) {
                console.error("Admin siparişleri yüklenirken hata:", error);
                allOrdersList.textContent = 'Siparişler yüklenemedi. Konsolu kontrol edin.';
            }

            // Tüm Açık Destek Talepleri
            const allTicketsList = document.getElementById('all-tickets-list');
            allTicketsList.innerHTML = '<p class="text-gray-500">Tüm açık talepler yükleniyor...</p>';
            try {
                const allTicketsSnapshot = await getDocs(getCollectionRef('allTickets'));
                const allTickets = [];
                allTicketsSnapshot.forEach(doc => allTickets.push({ id: doc.id, ...doc.data() }));
                
                allTickets.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                allTicketsList.innerHTML = '';
                if (allTickets.length === 0) {
                    allTicketsList.textContent = 'Sistemde hiç açık talep yok.';
                } else {
                    allTickets.forEach(ticket => allTicketsList.appendChild(createAdminTicketElement(ticket)));
                }
            } catch (error) {
                console.error("Admin talepleri yüklenirken hata:", error);
                allTicketsList.textContent = 'Talepler yüklenemedi. Konsolu kontrol edin.';
            }
        }
        
        // --- UTILITY: Create UI Elements ---

        function createOrderElement(order) {
            const statusColor = order.status === 'Beklemede' ? 'bg-yellow-100 text-yellow-800' :
                                order.status === 'İşleniyor' ? 'bg-blue-100 text-blue-800' :
                                order.status === 'Tamamlandı' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
            const dateStr = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Tarih Yok';
            
            const element = document.createElement('div');
            element.className = 'card p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center text-sm border-l-4 border-blue-500';
            element.innerHTML = `
                <div class="space-y-1 mb-2 sm:mb-0">
                    <p class="font-semibold text-gray-800">${order.category} - ${order.serviceName}</p>
                    <p class="text-gray-500 text-xs truncate max-w-xs sm:max-w-none">Link: <a href="${order.link}" target="_blank" class="text-blue-500 hover:underline">${order.link.substring(0, 50)}...</a></p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs">
                    <span class="font-mono bg-gray-100 rounded-full px-3 py-1">Miktar: ${order.quantity.toLocaleString()}</span>
                    <span class="${statusColor} font-bold rounded-full px-3 py-1">${order.status}</span>
                    <span class="text-gray-500">${dateStr}</span>
                </div>
            `;
            return element;
        }
        
        function createTicketElement(ticket) {
            const statusColor = ticket.status === 'Açık' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            const dateStr = ticket.createdAt ? new Date(ticket.createdAt.seconds * 1000).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Tarih Yok';

            const element = document.createElement('div');
            element.className = 'card p-4 rounded-lg border-l-4 border-red-500';
            element.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-semibold text-gray-800">${ticket.ticketSubject}</p>
                    <span class="${statusColor} font-bold text-xs rounded-full px-3 py-1">${ticket.status}</span>
                </div>
                <p class="text-gray-600 text-sm mt-1">${ticket.ticketMessage.substring(0, 100)}${ticket.ticketMessage.length > 100 ? '...' : ''}</p>
                <p class="text-gray-500 text-xs mt-2">ID: <span class="font-mono">${ticket.id}</span> - ${dateStr}</p>
            `;
            return element;
        }
        
        function createAdminOrderElement(order) {
            const statusColor = order.status === 'Beklemede' ? 'bg-yellow-100 text-yellow-800' :
                                order.status === 'İşleniyor' ? 'bg-blue-100 text-blue-800' :
                                order.status === 'Tamamlandı' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';

            const element = document.createElement('div');
            element.className = 'bg-white p-3 rounded-lg border border-gray-200 text-xs';
            element.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-gray-800 truncate max-w-[40%]">${order.userName}</span>
                    <span class="${statusColor} font-bold px-2 py-0.5 rounded-full">${order.status}</span>
                </div>
                <p class="text-gray-600">${order.category} / ${order.serviceName} - Miktar: ${order.quantity.toLocaleString()}</p>
                <p class="text-gray-400 font-mono break-all">User ID: ${order.userId}</p>
            `;
            return element;
        }

        function createAdminTicketElement(ticket) {
            const element = document.createElement('div');
            element.className = 'bg-white p-3 rounded-lg border border-gray-200 text-xs border-l-4 border-red-500';
            element.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-gray-800 truncate max-w-[40%]">${ticket.userName}</span>
                    <span class="bg-red-100 text-red-800 font-bold px-2 py-0.5 rounded-full">${ticket.status}</span>
                </div>
                <p class="text-gray-600 font-semibold">${ticket.ticketSubject}</p>
                <p class="text-gray-400 font-mono break-all">User ID: ${ticket.userId}</p>
            `;
            return element;
        }
        
        // --- NAVIGATION & UI UPDATES ---
        
        function toggleSidebar() {
            sidebar.classList.toggle('open');
        }

        function buildNavigation() {
            mainNavUl.innerHTML = '';
            
            const menuItems = [
                { id: 'newOrder', label: 'Yeni Sipariş', icon: 'fas fa-shopping-cart', authenticated: true },
                { id: 'orderHistory', label: 'Sipariş Geçmişi', icon: 'fas fa-history', authenticated: true },
                { id: 'support', label: 'Destek Talebi', icon: 'fas fa-life-ring', authenticated: true },
            ];

            if (appState.isAdmin) {
                menuItems.push({ id: 'adminPanel', label: 'Yönetici Paneli', icon: 'fas fa-user-shield', authenticated: true });
            }
            
            menuItems.push({ 
                label: 'Discord', 
                icon: 'fab fa-discord', 
                external: true, 
                href: 'https://discord.gg/invite' 
            });
            menuItems.push({ id: 'logout', label: 'Çıkış Yap', icon: 'fas fa-sign-out-alt', authenticated: true, action: handleLogout });


            menuItems.filter(item => item.authenticated === true).forEach(item => {
                const li = document.createElement('li');
                const link = document.createElement(item.external ? 'a' : 'button');
                
                link.className = 'nav-item w-full flex items-center p-3 rounded-lg text-left font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition-colors';
                link.innerHTML = `<i class="${item.icon} w-5 mr-3"></i> <span>${item.label}</span>`;
                
                if (item.external) {
                    link.href = item.href;
                    link.target = '_blank';
                } else if (item.action) {
                    link.onclick = item.action;
                } else {
                    link.onclick = () => {
                        handleNavigation(item.id);
                        toggleSidebar(); // Mobil'de menüyü kapat
                    };
                }

                if (item.id === appState.currentPage) {
                    link.classList.add('active');
                }
                
                li.appendChild(link);
                mainNavUl.appendChild(li);
            });
        }


        function handleNavigation(pageId) {
            appState.currentPage = pageId;
            updateUI();
        }

        function updateUI() {
            // Tüm sayfa konteynerlarını gizle
            pageContainers.forEach(container => container.classList.add('hidden'));

            const isAuthenticated = appState.currentUserId !== null;
            const targetPage = document.getElementById(appState.currentPage);

            // Yetkili sayfalara erişim kontrolü
            const isAuthPage = ['login', 'register', 'forgotPassword'].includes(appState.currentPage);
            const isGuestPage = !isAuthenticated && isAuthPage;
            const isUserPage = isAuthenticated && !isAuthPage;

            if (isGuestPage || isUserPage) {
                targetPage?.classList.remove('hidden');
            } else if (!isAuthenticated) {
                 // Yetkisiz kullanıcı yetkili sayfaya gitmeye çalışırsa login'e at
                 handleNavigation('login');
                 return;
            }

            // Sidebar ve Content Area görünürlüğünü ayarla
            if (isAuthenticated) {
                sidebar.classList.remove('lg:hidden');
                contentArea.style.marginLeft = 'var(--sidebar-width)';
                if (window.innerWidth < 1024) {
                    contentArea.style.marginLeft = '0'; // Mobil
                }
                
            } else {
                sidebar.classList.add('lg:hidden');
                contentArea.style.marginLeft = '0';
            }

            // Navigasyonu ve sayfa yüklemelerini güncelle
            buildNavigation();
            
            // Sayfa bazlı veri yükleme
            if (appState.currentPage === 'orderHistory') {
                loadUserOrders();
            } else if (appState.currentPage === 'support') {
                loadUserTickets();
            } else if (appState.currentPage === 'adminPanel' && appState.isAdmin) {
                loadAdminData();
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // Genel form gönderme işleyici (Login, Register, Forgot Password)
            document.querySelectorAll('#login, #register, #forgotPassword').forEach(section => {
                const form = section.querySelector('form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const email = document.getElementById(`${form.id.split('-')[0]}-email`).value;
                        const password = form.id === 'login-form' || form.id === 'register-form' ? document.getElementById(`${form.id.split('-')[0]}-password`).value : null;

                        if (appState.currentPage === 'login') {
                            handleLogin(email, password);
                        } else if (appState.currentPage === 'register') {
                            const displayName = document.getElementById('displayName').value;
                            handleRegister(email, password, displayName);
                        } else if (appState.currentPage === 'forgotPassword') {
                            handleForgotPassword(email);
                        }
                    });
                }
            });
            
            // Sipariş Formu İşleyici
            orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const btn = document.getElementById('order-submit-btn');
                const spinner = document.getElementById('order-spinner');
                const btnText = document.getElementById('order-btn-text');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                const serviceOption = serviceTypeSelect.options[serviceTypeSelect.selectedIndex];
                const pricePerK = serviceOption && serviceOption.dataset.price ? parseFloat(serviceOption.dataset.price) : 0;
                const quantity = parseInt(quantityInput.value, 10) || 0;
                const totalCost = (quantity / 1000) * pricePerK;
                
                if (quantity < 100 || pricePerK === 0) {
                    showModal("Hata", "Lütfen geçerli bir miktar (min 100) girin ve servis seçimi yapın.");
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    return;
                }

                const orderData = {
                    platform: platformSelect.value,
                    category: categorySelect.value,
                    serviceId: serviceTypeSelect.value,
                    serviceName: serviceOption.textContent.trim(),
                    link: document.getElementById('link').value,
                    quantity: quantity,
                    pricePerK: pricePerK,
                    totalCost: parseFloat(totalCost.toFixed(3)),
                };

                await saveOrder(orderData);

                btn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            });
            
            // Destek Talebi Formu İşleyici
            ticketForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const btn = document.getElementById('ticket-submit-btn');
                const spinner = document.getElementById('ticket-spinner');
                const btnText = document.getElementById('ticket-btn-text');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                const ticketData = {
                    ticketSubject: document.getElementById('ticketSubject').value,
                    ticketMessage: document.getElementById('ticketMessage').value,
                };
                
                await saveTicket(ticketData);

                btn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            });

            // Mobil cihazlarda dışarı tıklamada sidebar'ı kapat
            contentArea.addEventListener('click', () => {
                if (window.innerWidth < 1024 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });

            // İlk yüklendiğinde ve ekran boyutu değiştiğinde UI'ı ayarla
            window.addEventListener('resize', updateUI);
        });
        
        // --- GLOBAL ERİŞİM İÇİN EŞLEŞTİRMELER ---
        window.handleNavigation = handleNavigation;
        window.handleLogout = handleLogout;
        window.toggleSidebar = toggleSidebar;
        
        // --- SON YÜKLEME KONTROLÜ ---
        
        // Firebase başlatılmamışsa, DOMContentLoaded'da başlatılacaktır.
    </script>
</body>
</html>
