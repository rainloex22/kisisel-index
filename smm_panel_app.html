<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Fonksiyonel SMM Panel | Gemini Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* TEMA RENKLERİ VE GENEL STİL */
        :root {
            --primary-color: #3b82f6; /* Mavi Vurgu */
            --primary-light: #60a5fa;
            --bg-body: #f3f4f6;       /* Açık Gri Arka Plan */
            --bg-card: #ffffff;       /* Kart Arka Planı */
            --text-dark: #1f2937;
            --text-muted: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
        }

        /* Navigasyon Aktifliği için özel stil */
        .nav-link.active {
            background-color: var(--primary-color);
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5), 0 2px 4px -2px rgba(59, 130, 246, 0.5);
        }
        .nav-link.active .icon {
            color: white !important;
        }

        /* Giriş ve Kayıt Formları için merkezi düzen */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobil görünümde sidebar gizleme */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-30;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        
        /* Mobil menü overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .sidebar-visible + .sidebar-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Table responsive scroll */
        .table-wrapper {
            overflow-x: auto;
        }

        /* Fix for hidden content in small screen when not logged in */
        @media (min-width: 1024px) {
            #sidebar {
                position: sticky;
                width: 280px;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>

    <!-- YÜKLEME EKRANI -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <i class="fas fa-spinner fa-spin text-4xl text-primary-color mb-4"></i>
        <p class="text-lg font-medium text-text-dark">Panel Yükleniyor...</p>
    </div>
    
    <!-- Mobil Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay lg:hidden" onclick="toggleSidebar()"></div>

    <!-- ANA KAPSAYICI (Giriş/Kayıt VEYA Panel) -->
    <div id="app-container" class="hidden">
        
        <!-- Kimlik Doğrulama Sayfası (Login/Register) -->
        <div id="auth-page" class="auth-container bg-gray-100 hidden">
            <!-- İçerik JavaScript ile doldurulacak -->
        </div>

        <!-- Ana Panel (Dashboard, Siparişler vb.) -->
        <div id="main-panel" class="lg:flex hidden min-h-screen">
            
            <!-- Sidebar (Yan Menü) -->
            <div id="sidebar" class="w-72 bg-white shadow-xl sidebar-hidden lg:block">
                <div class="p-6 flex flex-col h-full">
                    <h1 class="text-3xl font-extrabold text-primary-color mb-8">Gemini Panel</h1>
                    
                    <!-- Kullanıcı Bilgi Kartı -->
                    <div id="user-info-card" class="p-4 bg-gray-100 rounded-lg shadow-inner mb-6">
                        <p class="text-sm font-semibold text-text-muted">Hoş Geldiniz,</p>
                        <p id="user-display-name" class="text-lg font-bold text-text-dark truncate"></p>
                        <div class="mt-2 flex justify-between items-center">
                            <p class="text-sm font-medium text-text-muted">Bakiye:</p>
                            <span id="user-balance" class="text-lg font-extrabold text-green-600">0.00 ₺</span>
                        </div>
                    </div>

                    <!-- Navigasyon Menüsü -->
                    <nav class="flex-grow">
                        <!-- Navigation links will be injected here -->
                    </nav>

                    <!-- Çıkış Butonu -->
                    <button onclick="handleLogout()" class="w-full mt-auto py-3 px-4 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-200 shadow-lg shadow-red-300">
                        <i class="fas fa-sign-out-alt mr-2"></i> Çıkış Yap
                    </button>
                </div>
            </div>

            <!-- Ana İçerik Alanı -->
            <div class="flex-1 p-4 sm:p-8">
                <!-- Mobil Sidebar Toggle ve Header -->
                <header class="flex lg:hidden justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
                    <button id="sidebar-toggle" class="text-2xl text-text-dark">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="text-xl font-bold text-primary-color">Gemini Panel</h2>
                    <span id="mobile-balance" class="text-xl font-bold text-green-600"></span>
                </header>

                <!-- İçerik Başlığı -->
                <div class="flex justify-between items-center mb-6">
                    <h2 id="page-title" class="text-3xl font-extrabold text-text-dark">Dashboard</h2>
                    <span id="page-action"></span>
                </div>

                <!-- Sayfa İçeriği -->
                <div id="page-content" class="min-h-[60vh]">
                    <!-- İçerik JavaScript ile doldurulacak -->
                </div>
            </div>
        </div>

    </div>

    <!-- Pop-up Mesaj Kutusu -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 id="message-title" class="text-xl font-bold mb-3 text-text-dark">Başlık</h3>
            <p id="message-body" class="text-gray-600 mb-4"></p>
            <button onclick="hideMessageBox()" class="w-full py-2 bg-primary-color text-white rounded-lg font-semibold hover:bg-primary-light transition">Kapat</button>
        </div>
    </div>


    <!-- Firebase Kütüphaneleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL DEĞİŞKENLER VE DURUM YÖNETİMİ ---
        let app, db, auth;
        let isFirebaseInitialized = false;

        // Uygulama durumu (State Management)
        const appState = {
            currentPage: 'loading', // 'loading', 'login', 'register', 'dashboard', 'newOrder', 'transactions', 'support'
            user: null, // Firebase User objesi
            isAuthReady: false, // Kimlik doğrulama işlemi tamamlandı mı?
            userData: { // Firestore'dan çekilen kullanıcı verileri
                balance: 0,
                orders: [],
                transactions: [],
                supportTickets: []
            },
            
            // Panel Hizmet Kataloğu (Gerçek bir API'den çekilmesi gereken verinin yerine geçer)
            smmData: {
                platforms: {
                    instagram: "Instagram",
                    tiktok: "TikTok",
                    youtube: "YouTube"
                },
                categories: {
                    instagram: {
                        followers: "Takipçi Hizmetleri",
                        likes: "Beğeni Hizmetleri",
                    },
                    tiktok: {
                        views: "Görüntüleme",
                        likes: "Beğeni",
                    },
                    youtube: {
                        subscribers: "Abone",
                        views: "Görüntüleme",
                    }
                },
                services: {
                    instagram: {
                        followers: [
                            { id: 101, name: "Türk Gerçek Takipçi (Hızlı)", pricePerK: 50.00, min: 100, max: 10000 },
                            { id: 102, name: "Yabancı Bot Takipçi (Ucuz)", pricePerK: 15.00, min: 500, max: 50000 },
                        ],
                        likes: [
                            { id: 103, name: "Türk Gerçek Beğeni", pricePerK: 20.00, min: 50, max: 20000 },
                        ],
                    },
                    tiktok: {
                        views: [
                            { id: 201, name: "Hızlı TikTok Görüntüleme", pricePerK: 5.00, min: 1000, max: 100000 },
                        ],
                        likes: [
                            { id: 202, name: "Türk TikTok Beğeni", pricePerK: 12.00, min: 50, max: 10000 },
                        ],
                    },
                    youtube: {
                        subscribers: [
                            { id: 301, name: "Garantili YouTube Abone", pricePerK: 120.00, min: 100, max: 5000 },
                        ],
                        views: [
                            { id: 302, name: "Yüksek Kaliteli YouTube İzlenme", pricePerK: 35.00, min: 500, max: 50000 },
                        ],
                    }
                }
            }
        };

        // --- FIREBASE İŞLEMLERİ ---

        // Firestore yolunu oluşturur (Özel Kullanıcı Verisi)
        const getPrivateDocPath = (collectionName) => {
            const userId = appState.user.uid;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // /artifacts/{appId}/users/{userId}/{collectionName}/data
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        };

        // Firestore'dan kullanıcı verilerini çeker ve anlık dinler (onSnapshot)
        const fetchUserData = () => {
            if (!appState.user) return;
            
            // 1. Kullanıcı Bilgileri ve Bakiyeyi Dinle
            const userDocRef = doc(db, getPrivateDocPath('user_data'), 'data');
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState.userData.balance = data.balance || 0;
                    appState.user.displayName = auth.currentUser.displayName || data.displayName || (appState.user.email ? appState.user.email.split('@')[0] : 'Kullanıcı');
                } else {
                    // Yeni kullanıcı, başlangıç bakiyesini ayarla
                    const initialDisplayName = auth.currentUser.displayName || (appState.user.email ? appState.user.email.split('@')[0] : 'Kullanıcı');
                    setDoc(userDocRef, { balance: 0, displayName: initialDisplayName }, { merge: true });
                    appState.userData.balance = 0;
                }
                updateUI(); // Bakiye değiştiğinde UI'ı güncelle
            }, (error) => {
                console.error("Kullanıcı verisi dinlenirken hata:", error);
            });

            // 2. Siparişleri Dinle
            const ordersCollectionRef = collection(db, getPrivateDocPath('orders'));
            onSnapshot(ordersCollectionRef, (snapshot) => {
                appState.userData.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                updateUI();
            }, (error) => {
                console.error("Siparişler dinlenirken hata:", error);
            });

            // 3. İşlemleri Dinle (Bakiye Yüklemeleri)
            const transactionsCollectionRef = collection(db, getPrivateDocPath('transactions'));
            onSnapshot(transactionsCollectionRef, (snapshot) => {
                appState.userData.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                updateUI();
            }, (error) => {
                console.error("İşlemler dinlenirken hata:", error);
            });
            
            // 4. Destek Taleplerini Dinle
             const supportCollectionRef = collection(db, getPrivateDocPath('support_tickets'));
            onSnapshot(supportCollectionRef, (snapshot) => {
                appState.userData.supportTickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                updateUI();
            }, (error) => {
                console.error("Destek talepleri dinlenirken hata:", error);
            });
        };

        // Gerçek Bakiye Yükleme (Manuel Ekleme)
        const addBalance = async (amount) => {
            if (!appState.user) return showMessageBox("Hata", "Giriş yapmalısınız.");
            
            const docRef = doc(db, getPrivateDocPath('user_data'), 'data');
            const transactionRef = collection(db, getPrivateDocPath('transactions'));

            try {
                // Bakiyeyi güncelle
                await updateDoc(docRef, { balance: appState.userData.balance + amount });

                // İşlem kaydını ekle
                await addDoc(transactionRef, {
                    type: 'Bakiye Yükleme (Manuel)',
                    amount: amount,
                    status: 'Tamamlandı',
                    timestamp: serverTimestamp(),
                    note: 'Kullanıcının manuel bakiye eklemesi'
                });

                showMessageBox("Başarılı", `${amount.toFixed(2)} ₺ bakiyeniz hesabınıza eklendi.`);
            } catch (error) {
                console.error("Bakiye yükleme hatası:", error);
                showMessageBox("Hata", "Bakiye yüklenirken bir sorun oluştu.");
            }
        };

        // Yeni sipariş oluşturma
        const placeNewOrder = async (platform, category, serviceId, link, quantity, price) => {
            if (!appState.user) return showMessageBox("Hata", "Giriş yapmalısınız.");

            if (appState.userData.balance < price) {
                return showMessageBox("Hata", "Bakiyeniz yetersiz. Lütfen bakiye yükleyin.");
            }

            const userDocRef = doc(db, getPrivateDocPath('user_data'), 'data');
            const ordersRef = collection(db, getPrivateDocPath('orders'));
            const service = appState.smmData.services[platform][category].find(s => s.id === parseInt(serviceId));
            
            if (!service) {
                 return showMessageBox("Hata", "Seçilen servis bulunamadı.");
            }

            try {
                // 1. Bakiyeden düş
                await updateDoc(userDocRef, { balance: appState.userData.balance - price });

                // 2. Siparişi ekle
                await addDoc(ordersRef, {
                    platform: appState.smmData.platforms[platform],
                    category: appState.smmData.categories[platform][category],
                    serviceName: service.name,
                    link: link,
                    quantity: quantity,
                    price: price,
                    status: 'Beklemede', // Beklemede, İşleniyor, Tamamlandı
                    timestamp: serverTimestamp()
                });

                showMessageBox("Başarılı", `Siparişiniz (${service.name}) başarıyla oluşturuldu. ${price.toFixed(2)} ₺ bakiyenizden düşüldü.`);
            } catch (error) {
                console.error("Sipariş oluşturma hatası:", error);
                // Hata durumunda bakiyeyi geri yüklemek gerekir (gerçek uygulamada transaction kullanılır)
                showMessageBox("Hata", "Sipariş oluşturulurken bir hata oluştu.");
            }
        };
        
        // Destek talebi gönderme
        const sendSupportTicket = async (subject, message) => {
             if (!appState.user) return showMessageBox("Hata", "Giriş yapmalısınız.");
             
             const supportRef = collection(db, getPrivateDocPath('support_tickets'));

             try {
                await addDoc(supportRef, {
                    subject: subject,
                    message: message,
                    status: 'Açık', // Açık, Yanıtlandı, Kapandı
                    timestamp: serverTimestamp(),
                    userEmail: appState.user.email
                });

                showMessageBox("Başarılı", "Destek talebiniz başarıyla alındı. Kayıt altına alındı.");
             } catch(e) {
                console.error("Destek talebi gönderme hatası:", e);
                showMessageBox("Hata", "Destek talebiniz gönderilemedi.");
             }
        }


        // --- KİMLİK DOĞRULAMA İŞLEMLERİ ---

        const handleRegister = async (email, password, displayName) => {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: displayName });
                showMessageBox("Başarılı", `Hoş geldiniz, ${displayName}! Kayıt tamamlandı ve giriş yapıldı.`);
            } catch (error) {
                console.error("Kayıt hatası:", error);
                let errorMessage = "Kayıt olurken bir hata oluştu.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Bu e-posta adresi zaten kullanılıyor.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Şifre en az 6 karakter olmalıdır.";
                }
                showMessageBox("Hata", errorMessage);
            }
        };

        const handleLogin = async (email, password) => {
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged tetiklenecek
            } catch (error) {
                console.error("Giriş hatası:", error);
                let errorMessage = "Giriş başarısız. E-posta veya şifre hatalı.";
                 if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Geçersiz e-posta veya şifre.";
                }
                showMessageBox("Hata", errorMessage);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged tetiklenir ve bizi login sayfasına yönlendirir.
            } catch (error) {
                console.error("Çıkış hatası:", error);
                showMessageBox("Hata", "Çıkış yapılırken bir sorun oluştu.");
            }
        };

        // --- NAVİGASYON VE UI İŞLEMLERİ ---

        const handleNavigation = (page) => {
            if (appState.user || page === 'login' || page === 'register') {
                appState.currentPage = page;
                updateUI();
            } else {
                appState.currentPage = 'login';
                updateUI();
            }
            // Mobil menüyü kapat
            document.getElementById('sidebar')?.classList.add('sidebar-hidden');
            document.getElementById('sidebar')?.classList.remove('sidebar-visible');
        };
        
        // Sidebar'ı göster/gizle
        const toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            sidebar?.classList.toggle('sidebar-hidden');
            sidebar?.classList.toggle('sidebar-visible');
        }

        // Genel mesaj kutusu gösterimi
        const showMessageBox = (title, body) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-box').classList.remove('hidden');
        };

        const hideMessageBox = () => {
            document.getElementById('message-box').classList.add('hidden');
        };

        // UI Güncelleme Fonksiyonu
        const updateUI = () => {
            // Yükleniyor ekranını yönet
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');

            if (appState.isAuthReady) {
                loadingScreen.classList.add('opacity-0');
                setTimeout(() => loadingScreen.classList.add('hidden'), 500);
                appContainer.classList.remove('hidden');
            } else {
                loadingScreen.classList.remove('hidden', 'opacity-0');
                appContainer.classList.add('hidden');
                return;
            }

            const authPage = document.getElementById('auth-page');
            const mainPanel = document.getElementById('main-panel');
            
            // Kimlik doğrulama veya Ana Panel görünümünü seç
            const isAuthPage = appState.currentPage === 'login' || appState.currentPage === 'register';

            if (isAuthPage) {
                authPage.classList.remove('hidden');
                mainPanel.classList.add('hidden');
                renderAuthPage(appState.currentPage);
            } else if (appState.user) {
                authPage.classList.add('hidden');
                mainPanel.classList.remove('hidden');
                renderMainPanel();
            } else {
                // Her ihtimale karşı login'e yönlendir
                appState.currentPage = 'login';
                updateUI();
            }
            
            // Sipariş sayfası için dinleyicileri tetikle
            if (appState.currentPage === 'newOrder') {
                setTimeout(initNewOrderListeners, 0); 
            }
        };
        
        // --- AUTH SAYFASI RENDER ---

        const renderAuthPage = (mode) => {
            const isLogin = mode === 'login';
            const authPage = document.getElementById('auth-page');

            const content = `
                <div class="bg-white p-8 sm:p-10 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300">
                    <h1 class="text-3xl font-extrabold text-primary-color mb-2 text-center">Gemini Panel</h1>
                    <h2 class="text-2xl font-bold text-text-dark mb-6 text-center">${isLogin ? 'Giriş Yap' : 'Kayıt Ol'}</h2>

                    <form id="auth-form" class="space-y-4">
                        ${!isLogin ? `
                            <div class="relative">
                                <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="displayName" placeholder="Adınız Soyadınız" required class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition duration-150">
                            </div>
                        ` : ''}
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="email" id="email" placeholder="E-posta Adresi" required class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition duration-150">
                        </div>
                        <div class="relative">
                            <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="password" id="password" placeholder="Şifre" required class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition duration-150">
                        </div>
                        
                        <button type="submit" class="w-full py-3 bg-primary-color text-white font-semibold rounded-xl hover:bg-primary-light transition duration-200 shadow-lg shadow-blue-300">
                            ${isLogin ? 'Giriş Yap' : 'Hemen Kayıt Ol'}
                        </button>
                    </form>

                    <p class="mt-6 text-center text-sm text-gray-600">
                        ${isLogin ? 'Hesabın yok mu?' : 'Zaten hesabın var mı?'}
                        <button onclick="handleNavigation('${isLogin ? 'register' : 'login'}')" class="text-primary-color font-semibold hover:underline ml-1">
                            ${isLogin ? 'Kayıt Ol' : 'Giriş Yap'}
                        </button>
                    </p>
                </div>
            `;
            authPage.innerHTML = content;

            // Form dinleyicisini bağla
            document.getElementById('auth-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                if (isLogin) {
                    handleLogin(email, password);
                } else {
                    const displayName = document.getElementById('displayName').value;
                    handleRegister(email, password, displayName);
                }
            });
        };

        // --- ANA PANEL RENDER ---

        const renderMainPanel = () => {
            // Sidebar Bilgilerini Güncelle
            document.getElementById('user-display-name').textContent = appState.user.displayName || (appState.user.email ? appState.user.email.split('@')[0] : 'Kullanıcı');
            document.getElementById('user-balance').textContent = `${appState.userData.balance.toFixed(2)} ₺`;
            document.getElementById('mobile-balance').textContent = `${appState.userData.balance.toFixed(2)} ₺`;
            
            // Navigasyon Menüsünü Oluştur
            const navItems = [
                { page: 'dashboard', icon: 'fas fa-tachometer-alt', label: 'Dashboard' },
                { page: 'newOrder', icon: 'fas fa-shopping-cart', label: 'Yeni Sipariş' },
                { page: 'orders', icon: 'fas fa-list-ul', label: 'Siparişlerim' },
                { page: 'transactions', icon: 'fas fa-wallet', label: 'Bakiye İşlemleri' },
                { page: 'support', icon: 'fas fa-headset', label: 'Destek' },
            ];
            
            const navHtml = navItems.map(item => `
                <button 
                    onclick="handleNavigation('${item.page}')" 
                    class="nav-link w-full flex items-center p-3 my-2 text-text-dark font-medium rounded-xl hover:bg-gray-100 transition duration-150 ${appState.currentPage === item.page ? 'active' : ''}">
                    <i class="icon ${item.icon} text-lg w-6 text-primary-color mr-3"></i>
                    <span>${item.label}</span>
                </button>
            `).join('');

            document.querySelector('#sidebar nav').innerHTML = navHtml;

            // İçerik Alanını Güncelle
            const pageTitle = document.getElementById('page-title');
            const pageContent = document.getElementById('page-content');
            const pageAction = document.getElementById('page-action');
            
            const currentNav = navItems.find(item => item.page === appState.currentPage);
            pageTitle.textContent = currentNav ? currentNav.label : 'Sayfa Başlığı';
            pageAction.innerHTML = '';
            pageContent.innerHTML = '';

            // Sayfa içeriklerini render et
            switch (appState.currentPage) {
                case 'dashboard':
                    renderDashboard(pageContent);
                    break;
                case 'newOrder':
                    renderNewOrder(pageContent, pageAction);
                    break;
                case 'orders':
                    renderOrders(pageContent);
                    break;
                case 'transactions':
                    renderTransactions(pageContent, pageAction);
                    break;
                case 'support':
                    renderSupport(pageContent);
                    break;
                default:
                    renderDashboard(pageContent);
                    break;
            }
        };

        // --- SAYFA RENDER FONKSİYONLARI ---

        const renderDashboard = (container) => {
            const totalOrders = appState.userData.orders.length;
            const completedOrders = appState.userData.orders.filter(o => o.status === 'Tamamlandı').length;
            const pendingOrders = appState.userData.orders.filter(o => o.status === 'Beklemede' || o.status === 'İşleniyor').length;
            const totalSpent = appState.userData.orders.reduce((sum, order) => sum + (order.price || 0), 0);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="p-6 bg-white rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Toplam Sipariş</p>
                            <p class="text-3xl font-bold text-text-dark">${totalOrders}</p>
                        </div>
                        <i class="fas fa-list-alt text-4xl text-primary-color opacity-30"></i>
                    </div>
                    <div class="p-6 bg-white rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Tamamlanan</p>
                            <p class="text-3xl font-bold text-text-dark">${completedOrders}</p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-green-500 opacity-30"></i>
                    </div>
                    <div class="p-6 bg-white rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Bekleyen / İşlenen</p>
                            <p class="text-3xl font-bold text-text-dark">${pendingOrders}</p>
                        </div>
                        <i class="fas fa-clock text-4xl text-yellow-500 opacity-30"></i>
                    </div>
                    <div class="p-6 bg-white rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Toplam Harcama</p>
                            <p class="text-3xl font-bold text-text-dark">${totalSpent.toFixed(2)} ₺</p>
                        </div>
                        <i class="fas fa-fire text-4xl text-red-500 opacity-30"></i>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-text-dark mb-4">Son 5 Siparişiniz</h3>
                    <div class="table-wrapper">
                        ${appState.userData.orders.length > 0 ? renderOrderTable(appState.userData.orders.slice(0, 5)) : '<p class="text-gray-500">Henüz bir siparişiniz yok. İlk siparişi oluşturun!</p>'}
                    </div>
                </div>
            `;
        };

        const renderNewOrder = (container, action) => {
            action.innerHTML = `<button onclick="handleNavigation('transactions')" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition shadow-md">Bakiye Yükle</button>`;

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <p class="text-lg font-semibold text-text-dark mb-4">Mevcut Bakiyeniz: <span class="text-green-600">${appState.userData.balance.toFixed(2)} ₺</span></p>
                    <form id="order-form" class="space-y-6">
                        
                        <!-- Platform Seçimi -->
                        <div>
                            <label for="platformSelect" class="block text-sm font-medium text-gray-700 mb-1">Platform Seçin</label>
                            <select id="platformSelect" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition">
                                <option value="">--- Seçiniz ---</option>
                                ${Object.entries(appState.smmData.platforms).map(([key, value]) => `<option value="${key}">${value}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Kategori Seçimi -->
                        <div>
                            <label for="categorySelect" class="block text-sm font-medium text-gray-700 mb-1">Kategori Seçin</label>
                            <select id="categorySelect" required disabled class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-primary-color focus:border-primary-color transition">
                                <option value="">Platform Seçiniz</option>
                            </select>
                        </div>

                        <!-- Servis Seçimi -->
                        <div>
                            <label for="serviceSelect" class="block text-sm font-medium text-gray-700 mb-1">Servis Seçin</label>
                            <select id="serviceSelect" required disabled class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-primary-color focus:border-primary-color transition">
                                <option value="">Kategori Seçiniz</option>
                            </select>
                            <p id="service-info" class="text-xs text-gray-500 mt-2 italic hidden"></p>
                        </div>

                        <!-- Link ve Miktar -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="linkInput" class="block text-sm font-medium text-gray-700 mb-1">Link (Gönderi veya Profil)</label>
                                <input type="url" id="linkInput" placeholder="https://..." required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition">
                            </div>
                            <div>
                                <label for="quantityInput" class="block text-sm font-medium text-gray-700 mb-1">Miktar</label>
                                <input type="number" id="quantityInput" placeholder="Min/Max miktar" required min="100" max="10000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition">
                            </div>
                        </div>
                        
                        <!-- Özet Kartı -->
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-lg font-semibold text-blue-800">Sipariş Özeti</p>
                            <div class="flex justify-between mt-2">
                                <span class="text-gray-600">Servis Fiyatı (1000 adet):</span>
                                <span id="price-per-k" class="font-bold text-gray-800">0.00 ₺</span>
                            </div>
                             <div class="flex justify-between mt-2">
                                <span class="text-gray-600">Sipariş Miktarı:</span>
                                <span id="quantity-summary" class="font-bold text-gray-800">0</span>
                            </div>
                            <div class="flex justify-between mt-3 pt-3 border-t border-blue-200">
                                <span class="text-xl font-bold text-blue-800">TOPLAM TUTAR:</span>
                                <span id="total-price" class="text-xl font-extrabold text-red-600">0.00 ₺</span>
                            </div>
                        </div>

                        <button type="submit" id="place-order-btn" disabled class="w-full py-3 bg-primary-color text-white font-semibold rounded-xl hover:bg-primary-light transition duration-200 shadow-lg shadow-blue-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-paper-plane mr-2"></i> Sipariş Ver
                        </button>
                    </form>
                </div>
            `;
        };
        
        // Sipariş sayfası için dinleyicileri ayarlar
        const initNewOrderListeners = () => {
            const platformSelect = document.getElementById('platformSelect');
            const categorySelect = document.getElementById('categorySelect');
            const serviceSelect = document.getElementById('serviceSelect');
            const quantityInput = document.getElementById('quantityInput');
            const serviceInfo = document.getElementById('service-info');
            const orderForm = document.getElementById('order-form');
            const placeOrderBtn = document.getElementById('place-order-btn');

            let currentService = null;

            const calculateCost = () => {
                const quantity = parseInt(quantityInput.value) || 0;
                
                let totalPrice = 0;

                // Miktar kısıtlamaları
                if (currentService) {
                    quantityInput.min = currentService.min;
                    quantityInput.max = currentService.max;
                    if (quantity >= currentService.min && quantity <= currentService.max) {
                        placeOrderBtn.disabled = false;
                        const pricePerItem = currentService.pricePerK / 1000;
                        totalPrice = pricePerItem * quantity;
                    } else {
                        placeOrderBtn.disabled = true;
                        if (quantity > 0) {
                            showMessageBox("Uyarı", `Seçilen hizmet için miktar ${currentService.min} ile ${currentService.max} arasında olmalıdır.`);
                        }
                    }
                } else {
                    placeOrderBtn.disabled = true;
                }
                
                document.getElementById('price-per-k').textContent = currentService ? `${currentService.pricePerK.toFixed(2)} ₺` : '0.00 ₺';
                document.getElementById('quantity-summary').textContent = quantity.toLocaleString('tr-TR');
                document.getElementById('total-price').textContent = `${totalPrice.toFixed(2)} ₺`;

                return totalPrice;
            };

            const updateCategorySelect = () => {
                categorySelect.innerHTML = '<option value="">--- Seçiniz ---</option>';
                serviceSelect.innerHTML = '<option value="">Kategori Seçiniz</option>';
                serviceSelect.disabled = true;
                serviceInfo.classList.add('hidden');
                currentService = null;
                calculateCost();
                quantityInput.value = '';

                const platformKey = platformSelect.value;
                if (platformKey && appState.smmData.categories[platformKey]) {
                    Object.entries(appState.smmData.categories[platformKey]).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        categorySelect.appendChild(option);
                    });
                    categorySelect.disabled = false;
                    categorySelect.classList.remove('bg-gray-50');
                } else {
                    categorySelect.disabled = true;
                    categorySelect.classList.add('bg-gray-50');
                }
            };
            
            const updateServiceSelect = () => {
                serviceSelect.innerHTML = '<option value="">--- Seçiniz ---</option>';
                serviceInfo.classList.add('hidden');
                currentService = null;
                calculateCost();
                quantityInput.value = '';
                
                const platformKey = platformSelect.value;
                const categoryKey = categorySelect.value;

                if (platformKey && categoryKey && appState.smmData.services[platformKey]?.[categoryKey]) {
                    appState.smmData.services[platformKey][categoryKey].forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.name;
                        serviceSelect.appendChild(option);
                    });
                    serviceSelect.disabled = false;
                    serviceSelect.classList.remove('bg-gray-50');
                } else {
                    serviceSelect.disabled = true;
                    serviceSelect.classList.add('bg-gray-50');
                }
            };

            const updateServiceInfo = () => {
                const serviceId = parseInt(serviceSelect.value);
                const platformKey = platformSelect.value;
                const categoryKey = categorySelect.value;
                
                currentService = null;
                serviceInfo.classList.add('hidden');
                placeOrderBtn.disabled = true;
                quantityInput.value = '';

                if (serviceId && platformKey && categoryKey) {
                    currentService = appState.smmData.services[platformKey][categoryKey].find(s => s.id === serviceId);
                }

                if (currentService) {
                    serviceInfo.textContent = `Min Miktar: ${currentService.min.toLocaleString('tr-TR')}, Max Miktar: ${currentService.max.toLocaleString('tr-TR')}, 1000 Adet Fiyatı: ${currentService.pricePerK.toFixed(2)} ₺`;
                    serviceInfo.classList.remove('hidden');
                    quantityInput.min = currentService.min;
                    quantityInput.max = currentService.max;
                    placeOrderBtn.disabled = false;
                } else {
                    quantityInput.min = 1;
                    quantityInput.max = 999999;
                }

                calculateCost();
            };

            platformSelect?.addEventListener('change', updateCategorySelect);
            categorySelect?.addEventListener('change', updateServiceSelect);
            serviceSelect?.addEventListener('change', updateServiceInfo);
            quantityInput?.addEventListener('input', calculateCost);
            
            // Form Submit
            orderForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const platform = platformSelect.value;
                const category = categorySelect.value;
                const serviceId = serviceSelect.value;
                const link = document.getElementById('linkInput').value;
                const quantity = parseInt(quantityInput.value);
                const price = calculateCost();

                if (price > 0 && currentService && quantity >= currentService.min && quantity <= currentService.max) {
                    placeNewOrder(platform, category, serviceId, link, quantity, price);
                    // Formu sıfırla
                    orderForm.reset();
                    updateServiceInfo(); // Özeti sıfırla
                } else if (!currentService) {
                    showMessageBox("Hata", "Lütfen geçerli bir servis seçimi yapın.");
                } else {
                    showMessageBox("Hata", "Sipariş miktarı veya fiyatı geçerli değil. Lütfen minimum ve maksimum miktarları kontrol edin.");
                }
            });
            
            // UI yüklendikten sonra (setTimeout ile) ilk değerleri tetikle
            updateCategorySelect();
        };

        const renderOrders = (container) => {
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-text-dark mb-4">Tüm Siparişlerim (${appState.userData.orders.length} adet)</h3>
                    <div class="table-wrapper">
                        ${appState.userData.orders.length > 0 ? renderOrderTable(appState.userData.orders) : '<p class="text-gray-500">Henüz oluşturulmuş bir siparişiniz bulunmamaktadır.</p>'}
                    </div>
                </div>
            `;
        };

        const renderOrderTable = (orders) => {
            const getStatusBadge = (status) => {
                switch (status) {
                    case 'Tamamlandı': return `<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">${status}</span>`;
                    case 'İşleniyor': return `<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${status}</span>`;
                    case 'Beklemede': return `<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">${status}</span>`;
                    default: return `<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${status}</span>`;
                }
            };
            
            return `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servis</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Miktar</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tutar</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${orders.map(order => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id.substring(0, 6)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.serviceName} (${order.platform})</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.quantity.toLocaleString('tr-TR')}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">${order.price.toFixed(2)} ₺</td>
                                <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(order.status)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.timestamp?.toDate ? new Date(order.timestamp.toDate()).toLocaleDateString('tr-TR') : 'Yükleniyor'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        };

        const renderTransactions = (container, action) => {
            action.innerHTML = ''; // Bakiye ekleme formu bu sayfada

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Bakiye Ekleme Formu -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h3 class="text-xl font-bold text-primary-color mb-4">Manuel Bakiye Ekleme</h3>
                        <p class="mb-4 text-gray-600">Mevcut Bakiyeniz: <span class="font-bold text-green-600">${appState.userData.balance.toFixed(2)} ₺</span></p>
                        <form id="balance-form" class="space-y-4">
                            <div>
                                <label for="depositAmount" class="block text-sm font-medium text-gray-700 mb-1">Yüklenecek Tutar (₺)</label>
                                <input type="number" id="depositAmount" value="50.00" min="5" step="0.01" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition">
                                <p class="text-xs text-gray-500 mt-1">Bu işlem, başarılı bir ödeme sonrası bakiyenin hesabınıza yansımasını temsil eder.</p>
                            </div>
                            <button type="submit" class="w-full py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition duration-200 shadow-lg shadow-green-300">
                                <i class="fas fa-plus-circle mr-2"></i> Bakiyeye Ekle
                            </button>
                        </form>
                    </div>

                    <!-- İşlem Geçmişi Tablosu -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-text-dark mb-4">İşlem Geçmişi (${appState.userData.transactions.length} adet)</h3>
                        <div class="table-wrapper">
                            ${appState.userData.transactions.length > 0 ? renderTransactionTable(appState.userData.transactions) : '<p class="text-gray-500">Henüz bakiye işlemi yapılmadı.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            // Form dinleyicisini bağla
            document.getElementById('balance-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('depositAmount').value);
                if (amount >= 5) {
                    addBalance(amount);
                    e.target.reset();
                } else {
                    showMessageBox("Hata", "Lütfen en az 5 ₺ tutarında geçerli bir miktar girin.");
                }
            });
        };

        const renderTransactionTable = (transactions) => {
            return `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İşlem Tipi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tutar</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${transactions.map(tx => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.timestamp?.toDate ? new Date(tx.timestamp.toDate()).toLocaleDateString('tr-TR') : 'Yükleniyor'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${tx.amount.toFixed(2)} ₺</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        const renderSupport = (container) => {
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto">
                    <h3 class="text-xl font-bold text-text-dark mb-4">Yeni Destek Talebi Oluştur</h3>
                    <p class="text-sm text-gray-500 mb-6">Talepleriniz Firestore'da kayıt altına alınır ve bir destek sistemi simülasyonu görevi görür.</p>
                    <form id="support-form" class="space-y-4">
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Konu</label>
                            <input type="text" id="subject" placeholder="Örn: Bakiye Yükleme Sorunu" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition">
                        </div>
                        <div>
                            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Mesajınız</label>
                            <textarea id="message" rows="5" placeholder="Detaylı sorununuzu veya önerinizi yazınız..." required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color transition"></textarea>
                        </div>
                        <button type="submit" class="w-full py-3 bg-primary-color text-white font-semibold rounded-xl hover:bg-primary-light transition duration-200 shadow-lg shadow-blue-300">
                            <i class="fas fa-paper-plane mr-2"></i> Talebi Gönder
                        </button>
                    </form>
                    
                    <div class="mt-8">
                        <h4 class="text-lg font-bold text-text-dark mb-3">Talepleriniz (${appState.userData.supportTickets.length})</h4>
                        <div class="space-y-3">
                        ${appState.userData.supportTickets.length > 0 ? 
                            appState.userData.supportTickets.map(ticket => `
                                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                                    <div class="flex justify-between items-center">
                                        <p class="font-semibold text-text-dark truncate">${ticket.subject}</p>
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${ticket.status === 'Açık' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${ticket.status}</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">ID: ${ticket.id.substring(0, 6)} - Tarih: ${ticket.timestamp?.toDate ? new Date(ticket.timestamp.toDate()).toLocaleDateString('tr-TR') : 'Yükleniyor'}</p>
                                </div>
                            `).join('')
                            : '<p class="text-gray-500 text-sm">Gönderilmiş bir destek talebiniz bulunmamaktadır.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            // Form dinleyicisini bağla
            document.getElementById('support-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const subject = document.getElementById('subject').value;
                const message = document.getElementById('message').value;
                sendSupportTicket(subject, message);
                e.target.reset();
            });
        };

        // --- BAŞLATMA VE AUTH AKIŞI ---

        window.onload = function() {
            // Sidebar toggle butonunu bağla (Mobil için)
            document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);

            // Firebase'i başlat ve kullanıcıyı kimlik doğrula
            try {
                // Global değişkenleri güvenli bir şekilde al
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    isFirebaseInitialized = true;
                    setLogLevel('Debug'); // Konsol loglarını aç

                    // Kimlik doğrulama durumunu dinle
                    onAuthStateChanged(auth, async (user) => {
                        appState.isAuthReady = true; // Auth dinleyicisi çalıştı
                        
                        if (user) {
                            appState.user = { uid: user.uid, email: user.email, displayName: user.displayName };
                            // Eğer login/register sayfasındaysa, dashboard'a yönlendir
                            if (appState.currentPage === 'login' || appState.currentPage === 'register' || appState.currentPage === 'loading') {
                                appState.currentPage = 'dashboard';
                            }
                            // Firestore'dan kullanıcı verilerini çekmeye başla
                            fetchUserData();
                        } else {
                            appState.user = null;
                            appState.currentPage = 'login'; // Giriş sayfasına yönlendir
                            // Kullanıcı çıkış yaptığında veriyi temizle
                            appState.userData = { balance: 0, orders: [], transactions: [], supportTickets: [] };
                        }
                        updateUI(); // Her auth durum değişiminde UI'ı güncelle
                    });

                    // Custom token ile giriş yapmayı dene (Canvas ortamı için)
                    // Token yoksa anonim olarak giriş yap. onAuthStateChanged her iki durumda da tetiklenir.
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        signInAnonymously(auth);
                    }
                } else {
                    // Firebase yapılandırması boşsa, yükleme ekranını kapat ve login'e git
                    console.error("Firebase yapılandırması boş. Panel verilerini kalıcı olarak saklayamayacak.");
                    appState.isAuthReady = true;
                    appState.currentPage = 'login';
                    updateUI();
                }
            } catch (e) {
                // Başlatma sırasında kritik hata oluşursa yükleme ekranını kapat
                console.error("Firebase başlatılırken KRİTİK hata:", e);
                appState.isAuthReady = true; 
                appState.currentPage = 'login';
                updateUI();
            }
        };
        
        // --- GLOBAL ERİŞİM İÇİN EŞLEŞTİRMELER ---
        window.handleNavigation = handleNavigation;
        window.handleLogout = handleLogout;
        window.showMessageBox = showMessageBox;
        window.hideMessageBox = hideMessageBox;

    </script>
</body>
</html>
