<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netici Paneli | bakikara.xyz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght(400);700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* TEMA RENKLERƒ∞ */
        :root {
            --primary-color: #5d3f6a;       /* Kapalƒ± Mor Vurgu */
            --bg-dark: #1e1e2d;             /* Koyu Arka Plan */
            --bg-card: #27293d;             /* Koyu Kart Arka Planƒ± */
            --text-light: #e0e0e0;          /* A√ßƒ±k Metin */
            --text-secondary: #a9a9b6;      /* ƒ∞kincil Metin */
            --border-dark: #3b3b51;         /* Koyu Sƒ±nƒ±r */
            --danger-color: #e74c3c;        /* Kƒ±rmƒ±zƒ± (Sil/√áƒ±kƒ±≈ü) */
            --success-color: #28a745;       /* Ye≈üil (Yayƒ±nda) */
            --warning-color: #ffc107;       /* Sarƒ± (Onay Bekliyor) */
            --info-color: #007bff;          /* Mavi (Dosya Bekleniyor) */
            --suspend-color: #f39c12;       /* Turuncu (Askƒ±da) */
            --passive-color: #7f8c8d;       /* Gri (Pasif) */
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* GENEL STƒ∞L */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-light);
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
        }
        .container {
            max-width: 1600px; 
            margin: 0 auto;
            padding: 40px 20px;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        /* KONTROL ALANI VE √ñZET KARTLARI */
        .controls-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* √úst hizalama */
            flex-wrap: wrap; /* K√º√ß√ºk ekranlarda alt alta gelme */
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-group {
            display: flex;
            gap: 20px; 
            flex-wrap: wrap;
        }
        
        .summary-card {
            background-color: var(--bg-card);
            padding: 15px 25px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            border-left: 5px solid var(--primary-color);
            box-shadow: var(--shadow);
            min-width: 180px; 
            transition: transform 0.3s;
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card strong {
            font-size: 1.5em;
            color: var(--primary-color);
        }
        
        .summary-card.active-card { border-left-color: var(--success-color); }
        .summary-card.pending-card { border-left-color: var(--warning-color); }


        /* Fƒ∞LTRE ALANI */
        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        #statusFilter, #searchFilter {
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        #statusFilter {
            width: 200px;
        }
        #searchFilter {
             width: 300px;
        }


        /* TABLO STƒ∞LLERƒ∞ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--bg-card);
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
        }
        .admin-table th, .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-dark);
        }
        .admin-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer; 
        }
        .admin-table th .sort-icon {
            margin-left: 5px;
            font-size: 0.7em;
            color: #d1c4e9;
        }
        .admin-table tr:hover td {
            background-color: #2e3046;
        }
        .admin-table td {
            color: var(--text-light);
            font-size: 0.9em;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 100px; 
            text-align: center;
        }
        .status-pending { background-color: var(--warning-color); color: #333; }
        .status-active { background-color: var(--success-color); color: white; }
        .status-file { background-color: var(--info-color); color: white; }
        .status-suspended { background-color: var(--suspend-color); color: white; }
        .status-passive { background-color: var(--passive-color); color: white; }
        .action-btn {
            background-color: var(--info-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s;
        }
        .action-btn:hover {
            opacity: 0.9;
        }
        .action-btn.delete-btn {
            background-color: var(--danger-color);
        }
        .action-btn.detail-btn {
            background-color: #00bcd4;
        }
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 20px;
            right: 20px;
            transition: background-color 0.3s;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        #loading, #error-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        /* DUYURU ALANI STƒ∞LLERƒ∞ */
        .announcement-area {
            margin-top: 40px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .announcement-area h2 {
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }
        #announcementText {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            resize: vertical;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        #publishAnnouncementBtn {
            background-color: var(--primary-color);
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #publishAnnouncementBtn:hover {
            background-color: #7b578c;
        }

        /* AKTƒ∞Vƒ∞TE ALANI STƒ∞LLERƒ∞ */
        .activity-area {
            margin-top: 40px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .activity-area h2 {
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .activity-list li {
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-dark);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-list li:last-child {
            border-bottom: none;
        }
        .activity-meta {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-left: 10px;
            min-width: 120px; /* Tarih/saat i√ßin yer ayƒ±r */
            text-align: right;
        }
        .activity-text {
            flex-grow: 1;
            text-align: left;
            padding-right: 10px;
        }

        /* MODAL (√ñzel Pencere) STƒ∞LLERƒ∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Varsayƒ±lan olarak gizli */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        .modal-input-group label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        .modal-input-group input, .modal-input-group select, .modal-input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Tasarƒ±m */
        @media (max-width: 900px) {
            .controls-area {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .summary-group, .filter-group {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .summary-card {
                width: 100%;
                min-width: unset;
            }
            #statusFilter, #searchFilter {
                 width: 100%;
            }
            .admin-table thead {
                display: none; 
            }
            .admin-table, .admin-table tbody, .admin-table tr, .admin-table td {
                display: block;
                width: 100%;
            }
            .admin-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-dark);
                border-radius: 8px;
            }
            .admin-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: none;
            }
            .admin-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--primary-color);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <button class="logout-btn" onclick="handleLogout()">√áƒ±kƒ±≈ü Yap</button>
    <h1><i class="fas fa-user-shield"></i> Y√∂netici Paneli - M√º≈üteriler</h1>

    <div class="controls-area">
        <div class="summary-group">
            <div class="summary-card total-card">
                Toplam M√º≈üteri: <strong id="totalCustomers">0</strong>
            </div>
            <div class="summary-card active-card">
                Aktif/Yayƒ±nda: <strong id="activeCustomers">0</strong>
            </div>
            <div class="summary-card pending-card">
                Onay Bekleyen: <strong id="pendingCustomers">0</strong>
            </div>
        </div>
        <div class="filter-group">
            <select id="statusFilter" onchange="filterCustomers()">
                 <option value="ALL">T√ºm Durumlar</option>
                 <option value="ACTIVE">YAYINDA</option>
                 <option value="PENDING">Onay Bekliyor</option>
                 <option value="SUSPENDED">ASKIYA ALINDI</option>
                 <option value="PASSIVE">PASƒ∞F</option>
                 <option value="FILE_WAITING">Dosya Bekleniyor</option>
            </select>
            <input type="text" id="searchFilter" placeholder="E-posta veya kullanƒ±cƒ± adƒ± ile ara..." onkeyup="filterCustomers()">
        </div>
    </div>
    <div class="announcement-area">
        <h2><i class="fas fa-bullhorn"></i> Yeni Duyuru Yayƒ±nla</h2>
        <div class="announcement-card">
            <textarea id="announcementText" placeholder="M√º≈üterilerinize g√∂ndermek istediƒüiniz duyuru metnini buraya yazƒ±n..." rows="3"></textarea>
            <button id="publishAnnouncementBtn" class="action-btn">Duyuruyu Yayƒ±nla</button>
            <p id="announcementMessage" style="margin-top: 10px; color: var(--text-light);"></p>
        </div>
    </div>
    <div id="loading">M√º≈üteri verileri y√ºkleniyor...</div>
    <div id="error-message" style="display:none;"></div>
    
    <table class="admin-table" id="customerTable" style="display:none;">
        <thead>
            <tr>
                <th onclick="sortCustomers('email')">E-posta / Site Adƒ± <span id="sortEmail" class="sort-icon fas fa-sort"></span></th>
                <th onclick="sortCustomers('created_at')">Kayƒ±t Tarihi <span id="sortCreated_at" class="sort-icon fas fa-sort-down"></span></th> 
                <th onclick="sortCustomers('balance')">Bakiye (‚Ç∫) <span id="sortBalance" class="sort-icon fas fa-sort"></span></th>
                <th>Site Adresi (√ñneri)</th>
                <th onclick="sortCustomers('serviceStatus')">Durum <span id="sortStatus" class="sort-icon fas fa-sort"></span></th>
                <th>ƒ∞≈ülemler</th>
            </tr>
        </thead>
        <tbody id="customerTableBody">
        </tbody>
    </table>
    <div class="activity-area">
        <h2><i class="fas fa-history"></i> Son Y√∂netici Aktivitesi (Duyurular)</h2>
        <ul id="announcementList" class="activity-list">
            <li>Aktivite y√ºkleniyor...</li>
        </ul>
    </div>
    </div>

<div id="customModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle">Mesaj</h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
            <button id="modalConfirmBtn" class="action-btn" style="background-color: var(--success-color);">Onayla</button>
            <button id="modalCancelBtn" class="action-btn" style="background-color: var(--passive-color);">Kapat</button>
        </div>
    </div>
</div>

<div id="detailModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3><i class="fas fa-edit"></i> M√º≈üteri Detaylarƒ±nƒ± D√ºzenle</h3>
        <div class="modal-input-group">
            <label for="detailEmail">E-posta:</label>
            <input type="text" id="detailEmail" disabled>
        </div>
        <div class="modal-input-group">
            <label for="detailSiteName">Site Adƒ±:</label>
            <input type="text" id="detailSiteName">
        </div>
        <div class="modal-input-group">
            <label for="detailBalance">Bakiye (‚Ç∫):</label>
            <input type="number" id="detailBalance" step="0.01">
        </div>
        <div class="modal-input-group">
            <label for="detailStatus">Durum:</label>
            <select id="detailStatus">
                <option value="ACTIVE">YAYINDA</option>
                <option value="PENDING">Onay Bekliyor</option>
                <option value="SUSPENDED">ASKIYA ALINDI</option>
                <option value="PASSIVE">PASƒ∞F</option>
                <option value="FILE_WAITING">Dosya Bekleniyor</option>
            </select>
        </div>
        <div class="modal-input-group">
            <label for="detailNotes">Y√∂netici Notlarƒ±:</label>
            <textarea id="detailNotes" rows="3" placeholder="Bu m√º≈üteriyle ilgili √∂nemli notlarƒ±nƒ±zƒ± buraya yazƒ±n."></textarea>
        </div>
        <p id="detailMessage" style="margin-top: 10px; color: var(--text-light);"></p>
        <div class="modal-buttons">
            <button id="saveDetailsBtn" class="action-btn" style="background-color: var(--primary-color);">Kaydet</button>
            <button id="closeDetailModalBtn" class="action-btn" style="background-color: var(--passive-color);">ƒ∞ptal</button>
        </div>
    </div>
</div>
<script type="module">
    // ----------------------------------------------------------------------
    // üî• ADIM 1: SUPABASE BAƒûLANTI AYARLARI
    // ----------------------------------------------------------------------
    const SUPABASE_URL = 'https://rqbbxjuncwwgtkbcqtet.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxYmJ4anVuY3d3Z3RrYmNxdGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzM1NjAsImV4cCI6MjA3ODAwOTU2MH0.8dzDoL8MEgbrL7b-ocJ79c9ts9qtSbFT3EashQZXyZQ'; 
    
    // CDN √ºzerinden global olarak eklenen Supabase client'ƒ± ba≈ülat
    const { createClient } = supabase; 
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { 
            // Ge√ßici olarak Auth persistSession √∂zelliƒüini kapatƒ±yoruz. 
            // Y√∂netici giri≈üi i√ßin bu kƒ±sƒ±m sonradan Supabase Auth ile deƒüi≈ütirilmelidir.
            persistSession: false 
        }
    });

    // üî• Dƒ∞KKAT: Y√∂netici Kontrol√º ge√ßici olarak devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈ütƒ±r.
    const ADMIN_EMAIL = "mehmeteminacan13@gmail.com"; 
    
    const loading = document.getElementById('loading');
    const table = document.getElementById('customerTable');
    const tableBody = document.getElementById('customerTableBody');
    const errorMessage = document.getElementById('error-message');
    
    const totalCustomersSpan = document.getElementById('totalCustomers');
    const activeCustomersSpan = document.getElementById('activeCustomers');
    const pendingCustomersSpan = document.getElementById('pendingCustomers');
    const announcementList = document.getElementById('announcementList');
    
    let allCustomers = [];
    let currentEditingUser = null; 
    let sortKey = 'created_at'; // üî• D√úZELTME: Ba≈ülangƒ±√ß sƒ±ralama anahtarƒ± created_at olarak deƒüi≈ütirildi
    let sortDirection = 'desc'; 

    // ----------------------------------------------------------------------
    // 1. √ñZEL MODAL ƒ∞≈ûLEVLERƒ∞ (Aynƒ± kaldƒ±)
    // ----------------------------------------------------------------------

    /**
     * √ñzel bir onay (confirm) veya bildirim (alert) penceresi g√∂sterir.
     */
    function showModal(title, message, type = 'alert', callback = () => {}) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        if (type === 'confirm') {
            confirmBtn.style.display = 'inline-block';
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                callback(true); 
            };
            cancelBtn.innerText = 'ƒ∞ptal';
        } else {
            confirmBtn.style.display = 'none';
            cancelBtn.innerText = 'Kapat';
        }

        cancelBtn.onclick = () => {
            modal.style.display = 'none';
            if (type === 'confirm') {
                 callback(false); 
            }
        };

        modal.style.display = 'flex';
    }


    // ----------------------------------------------------------------------
    // 2. M√ú≈ûTERƒ∞ TABLOSU ve Fƒ∞LTRE/SIRA ƒ∞≈ûLEVLERƒ∞
    // ----------------------------------------------------------------------
    
    /**
     * M√º≈üteri Durumlarƒ± ve Etiket Olu≈üturma Fonksiyonu
     */
    function getStatusBadge(status) {
        let className = 'status-file';
        let text = 'Dosya Bekleniyor';
        
        switch (status) {
            case 'ACTIVE':
                className = 'status-active';
                text = 'YAYINDA';
                break;
            case 'PENDING':
                className = 'status-pending';
                text = 'Onay Bekliyor';
                break;
            case 'SUSPENDED':
                className = 'status-suspended';
                text = 'ASKIYA ALINDI';
                break;
            case 'PASSIVE':
                className = 'status-passive';
                text = 'PASƒ∞F';
                break;
            case 'FILE_WAITING':
            default:
                className = 'status-file';
                text = 'Dosya Bekleniyor';
                break;
        }
        return `<span class="status-badge ${className}" data-status="${status}">${text}</span>`;
    }

    /**
     * M√º≈üteri verilerini tabloya i≈üleyen ana render fonksiyonu
     */
    function renderTable(customers) {
        // Sƒ±ralama uygula
        customers.sort((a, b) => {
            let aVal = a[sortKey];
            let bVal = b[sortKey];

            // üî• D√úZELTME: created_at kullanƒ±lƒ±yor
            if (sortKey === 'created_at') { 
                // Supabase'den gelen tarih string'ini Date nesnesine √ßevir
                aVal = aVal ? new Date(aVal).getTime() : 0;
                bVal = bVal ? new Date(bVal).getTime() : 0;
            }
            if (sortKey === 'balance') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        tableBody.innerHTML = '';

        // Sƒ±ralama ikonu g√ºncelleme
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort');
        });
        // üî• D√úZELTME: Sadece created_at'i ayrƒ± ele al
        let iconId = '';
        if (sortKey === 'created_at') {
            iconId = 'sortCreated_at';
        } else {
            iconId = `sort${sortKey.charAt(0).toUpperCase() + sortKey.slice(1)}`;
        }
        
        const currentSortIcon = document.getElementById(iconId);
        
        if (currentSortIcon) {
             currentSortIcon.classList.remove('fa-sort');
             currentSortIcon.classList.add(sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
        }

        if (customers.length === 0) {
            // Tablo s√ºtun sayƒ±sƒ± 6 oldu (E-posta, Tarih, Bakiye, Adres, Durum, ƒ∞≈ülemler)
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--warning-color);">Filtreye uyan m√º≈üteri bulunamadƒ±.</td></tr>`;
            return;
        }

        customers.forEach(user => {
            const userEmail = user.email || 'Bilinmiyor';
            const username = userEmail.split('@')[0];
            const siteUrl = `bakikara.xyz/${user.site_adi || username}`; // Site adƒ± varsa onu kullan
            // üî• D√úZELTME: user.created_at kullanƒ±lƒ±yor
            const regDate = user.created_at ? new Date(user.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Bilinmiyor';
            const status = user.serviceStatus || 'FILE_WAITING'; 
            const balance = (user.balance || 0).toFixed(2); // Bakiye deƒüeri

            const row = tableBody.insertRow();
            
            row.innerHTML = `
                <td data-label="E-posta / Site Adƒ±">
                    <strong>${userEmail}</strong><br>
                    <span style="color:var(--text-secondary);">${user.site_adi || 'Site Adƒ± Yok'}</span>
                </td>
                <td data-label="Kayƒ±t Tarihi">${regDate}</td>
                <td data-label="Bakiye (‚Ç∫)">‚Ç∫ ${balance}</td>
                <td data-label="Site Adresi (√ñneri)"><a href="http://${siteUrl}" target="_blank" style="color:var(--info-color);">${siteUrl}</a></td>
                <td data-label="Durum">${getStatusBadge(status)}</td>
                <td data-label="ƒ∞≈ülemler">
                    <button class="action-btn detail-btn" onclick="window.showCustomerDetailModal('${user.user_id}')"><i class="fas fa-search"></i> Detay/D√ºzenle</button>
                    <button class="action-btn open-site-btn" onclick="window.openCustomerSite('${siteUrl}')"><i class="fas fa-external-link-alt"></i> Siteyi A√ß</button>
                    <button class="action-btn" onclick="window.updateCustomerStatus('${user.user_id}', 'ACTIVE')"><i class="fas fa-check"></i> Yayƒ±na Al</button>
                    <button class="action-btn delete-btn" onclick="window.deleteCustomer('${user.user_id}')"><i class="fas fa-trash-alt"></i> Sil</button>
                </td>
            `;
        });
    }

    /**
     * Tablo ba≈ülƒ±ƒüƒ±na tƒ±klandƒ±ƒüƒ±nda sƒ±ralama yapar
     */
    window.sortCustomers = function(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortKey = key;
            sortDirection = 'asc'; 
            // üî• D√úZELTME: created_at kullanƒ±lƒ±yor
            if (key === 'created_at' || key === 'balance') sortDirection = 'desc'; 
        }
        filterCustomers(); // Veriyi yeniden render et
    }

    /**
     * Arama ve Durum Filtreleme Fonksiyonu
     */
    window.filterCustomers = function() {
        const searchText = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value; // Yeni filtre

        const filtered = allCustomers.filter(user => {
            const userEmail = (user.email || '').toLowerCase();
            const username = userEmail.split('@')[0].toLowerCase();
            const siteAdi = (user.site_adi || '').toLowerCase();
            const status = (user.serviceStatus || 'FILE_WAITING');
            
            // Metin aramasƒ± kontrol√º
            const textMatch = userEmail.includes(searchText) || username.includes(searchText) || siteAdi.includes(searchText);
            
            // Durum filtresi kontrol√º
            const statusMatch = statusFilter === 'ALL' || status === statusFilter;

            return textMatch && statusMatch;
        });

        renderTable(filtered);
    }

    // ----------------------------------------------------------------------
    // 3. GER√áEK ZAMANLI VERƒ∞ √áEKME (SUPABASE REALTIME)
    // ----------------------------------------------------------------------

    /**
     * Veriyi bir kez √ßeken ana fonksiyon (Firestore'daki getDocs'a kar≈üƒ±lƒ±k gelir)
     */
    async function fetchAndRenderCustomers() {
        loading.style.display = 'block';

        try {
            // Supabase'den t√ºm m√º≈üterileri √ßek
            const { data: customers, error } = await supabaseClient
                .from('customers') // Olu≈üturduƒüumuz tablo adƒ±
                .select('*') 
                // üî• D√úZELTME: created_at kullanƒ±lƒ±yor
                .order('created_at', { ascending: false }); 

            if (error) {
                throw error;
            }

            loading.style.display = 'none';
            table.style.display = 'table';
            
            if (!customers || customers.length === 0) {
                loading.innerText = 'Hen√ºz kayƒ±tlƒ± m√º≈üteri bulunmamaktadƒ±r.';
                loading.style.display = 'block';
                allCustomers = [];
                renderTable([]);
                
                totalCustomersSpan.innerText = '0';
                activeCustomersSpan.innerText = '0';
                pendingCustomersSpan.innerText = '0';
                return;
            }

            // user_id Firestore'da doc.id iken, Supabase'de tablo s√ºtun adƒ±mƒ±zdƒ±r
            allCustomers = customers.map(doc => ({
                userId: doc.user_id, // Firestore'daki userId yerine Supabase'deki user_id s√ºtunu
                ...doc
            }));

            // √ñzet Kartlarƒ± G√ºncelle
            const activeCount = allCustomers.filter(u => u.serviceStatus === 'ACTIVE').length;
            const pendingCount = allCustomers.filter(u => u.serviceStatus === 'PENDING' || u.serviceStatus === 'FILE_WAITING').length; 
            
            totalCustomersSpan.innerText = allCustomers.length;
            activeCustomersSpan.innerText = activeCount;
            pendingCustomersSpan.innerText = pendingCount; 

            // Mevcut filtre ve sƒ±ralama ayarlarƒ±nƒ± kullanarak tabloyu yeniden √ßiz
            filterCustomers();

        } catch (error) {
            console.error("Supabase Veri √áekme Hatasƒ±:", error.message);
            loading.style.display = 'none';
            errorMessage.innerText = `Veri dinleme hatasƒ±: ${error.message}`;
            errorMessage.style.display = 'block';
        }
    }


    /**
     * M√º≈üteri Verilerini Ger√ßek Zamanlƒ± Dinleme ve √ñzet Kartlarƒ± G√ºncelleme
     */
    function listenForCustomers() {
        loading.style.display = 'block';
        table.style.display = 'none';
        errorMessage.style.display = 'none';
        
        // Supabase Realtime Dinleyicisini Ba≈ülat
        const channel = supabaseClient
            .channel('customer_changes') 
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'customers' }, // customers tablosundaki her deƒüi≈üikliƒüi dinle
                (payload) => {
                    console.log('Ger√ßek Zamanlƒ± Veri Deƒüi≈üikliƒüi Algƒ±landƒ±:', payload);
                    // Deƒüi≈üiklik olduƒüunda t√ºm listeyi yeniden √ßekip render et
                    fetchAndRenderCustomers();
                }
            )
            .subscribe(); 

        // ƒ∞lk veriyi √ßekme fonksiyonunu √ßaƒüƒ±r
        fetchAndRenderCustomers();

        return channel;
    };
    
    /**
     * En son yayƒ±nlanan duyurularƒ± (aktivite) √ßeker ve dinler. (≈ûimdilik sadece √ßeker)
     */
    async function listenForRecentActivity() {
        console.log("Aktivite dinleyicisi ba≈ülatƒ±ldƒ±...");
        
        try {
            // Supabase'den son 5 duyuruyu √ßek
            const { data: announcements, error } = await supabaseClient
                // üî• D√úZELTME: created_at kullanƒ±lƒ±yor
                .from('announcements')
                .select('text, created_at') // Sadece metin ve olu≈üturulma tarihi
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) throw error;
            
            announcementList.innerHTML = ''; 
            
            if (announcements.length === 0) {
                announcementList.innerHTML = `<li><i class="fas fa-info-circle"></i> Hen√ºz yayƒ±nlanmƒ±≈ü bir duyuru yok.</li>`;
                return;
            }

            announcements.forEach(announcement => {
                // üî• D√úZELTME: announcement.created_at kullanƒ±lƒ±yor
                const date = announcement.created_at ? new Date(announcement.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Bilinmiyor';
                
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="activity-text"><i class="fas fa-bell" style="color:var(--primary-color);"></i> ${announcement.text.substring(0, 70)}${announcement.text.length > 70 ? '...' : ''}</span>
                    <span class="activity-meta">${date}</span>
                `;
                announcementList.appendChild(listItem);
            });

        } catch (error) {
            console.error("Aktivite dinlenirken hata olu≈ütu:", error);
            announcementList.innerHTML = `<li><i class="fas fa-exclamation-triangle" style="color:var(--danger-color);"></i> Aktivite y√ºklenirken hata olu≈ütu.</li>`;
        }
    }

    // ----------------------------------------------------------------------
    // 4. DUYURU Y√ñNETƒ∞Mƒ∞ (SUPABASE INSERT)
    // ----------------------------------------------------------------------

    /**
     * Yeni Duyuru Ekleme Fonksiyonu
     */
    async function publishAnnouncement() {
        const textElement = document.getElementById('announcementText');
        const messageElement = document.getElementById('announcementMessage');
        const btn = document.getElementById('publishAnnouncementBtn');
        
        const announcementText = textElement.value.trim();

        if (announcementText.length < 5) {
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = 'Duyuru metni en az 5 karakter olmalƒ±dƒ±r.';
            return;
        }

        messageElement.innerText = 'Yayƒ±nlanƒ±yor...';
        btn.disabled = true;

        try {
            // Supabase ile Duyuru Ekleme
            const { error } = await supabaseClient
                .from('announcements') // announcements tablosuna ekle
                .insert([
                    {
                        text: announcementText,
                        // createdAt alanƒ± Supabase'de otomatik eklenebilir
                        publishedBy: ADMIN_EMAIL 
                    }
                ]);

            if (error) throw error;

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = '‚úÖ Duyuru ba≈üarƒ±yla yayƒ±nlandƒ±! (M√º≈üteri sitelerinde g√∂r√ºnecek)';
            textElement.value = ''; 
            
            // Yayƒ±n ba≈üarƒ±lƒ± olduƒüunda aktivite listesini g√ºncelle
            listenForRecentActivity();

        } catch (error) {
            console.error("Duyuru yayƒ±nlanƒ±rken hata olu≈ütu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Duyuru hatasƒ±: ${error.message}`;
        } finally {
            btn.disabled = false;
            setTimeout(() => messageElement.innerText = '', 5000); 
        }
    }
    
    // ----------------------------------------------------------------------
    // 5. M√ú≈ûTERƒ∞ ƒ∞≈ûLEM FONKSƒ∞YONLARI (SUPABASE UPDATE/DELETE)
    // ----------------------------------------------------------------------

    /**
     * M√º≈üteri Durumunu G√ºncelleme
     */
    window.updateCustomerStatus = function(userId, newStatus) {
        let statusText = '';
        if (newStatus === 'ACTIVE') statusText = 'YAYINA AL';
        else if (newStatus === 'SUSPENDED') statusText = 'ASKIYA AL';
        else statusText = newStatus;
        
        showModal(
            "Durum G√ºncelleme",
            `Kullanƒ±cƒ± ID: ${userId} durumunu ${statusText} olarak g√ºncellemek istediƒüinizden emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        // Supabase ile G√ºncelleme
                        const { error } = await supabaseClient
                            // Supabase'in otomatik last_updated alanƒ±nƒ± kullanmak i√ßin burada lastUpdated yerine last_updated kullanƒ±lmasƒ± gerekebilir.
                            .from('customers')
                            .update({ serviceStatus: newStatus, lastUpdated: new Date().toISOString() }) 
                            .eq('user_id', userId); // user_id'si e≈üle≈üeni bul

                        if (error) throw error;

                        showModal("Ba≈üarƒ±lƒ±", `Durum ba≈üarƒ±yla ${statusText} olarak g√ºncellendi.`, 'alert');
                    } catch (error) {
                        console.error("Durum g√ºncellenirken hata olu≈ütu:", error);
                        showModal("Hata", "Durum g√ºncellenirken bir hata olu≈ütu: " + error.message, 'alert');
                    }
                }
            }
        );
    }

    /**
     * M√º≈üteriyi Silme
     */
    window.deleteCustomer = function(userId) {
        showModal(
            "Kalƒ±cƒ± Silme Onayƒ±",
            `Dƒ∞KKAT! Kullanƒ±cƒ± ID: ${userId} kalƒ±cƒ± olarak silinecektir. Bu i≈ülem geri alƒ±namaz. Emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        // Supabase ile Silme
                        const { error } = await supabaseClient
                            .from('customers')
                            .delete()
                            .eq('user_id', userId); // user_id'si e≈üle≈üeni sil

                        if (error) throw error;
                            
                        showModal("Ba≈üarƒ±lƒ±", `Kullanƒ±cƒ± ba≈üarƒ±yla silindi.`, 'alert');
                    } catch (error) {
                        console.error("Kullanƒ±cƒ± silinirken hata olu≈ütu:", error);
                        showModal("Hata", "Kullanƒ±cƒ± silinirken bir hata olu≈ütu: " + error.message, 'alert');
                    }
                }
            }
        );
    }
    
    /**
     * M√º≈üterinin Sitesini A√ßma
     */
    window.openCustomerSite = function(siteUrl) {
        window.open(`http://${siteUrl}`, '_blank');
    }

    // ----------------------------------------------------------------------
    // 6. DETAY/D√úZENLE MODALI ƒ∞≈ûLEVLERƒ∞ (SUPABASE UPDATE)
    // ----------------------------------------------------------------------
    
    window.showCustomerDetailModal = function(userId) {
        // userId artƒ±k Firestore doc.id yerine Supabase'deki user_id s√ºtunudur
        const user = allCustomers.find(u => u.userId === userId); 
        if (!user) return;

        currentEditingUser = user;
        
        document.getElementById('detailEmail').value = user.email || '';
        document.getElementById('detailSiteName').value = user.site_adi || '';
        document.getElementById('detailBalance').value = (user.balance || 0); // Bakiye deƒüeri
        document.getElementById('detailStatus').value = user.serviceStatus || 'FILE_WAITING';
        document.getElementById('detailNotes').value = user.admin_notes || '';
        document.getElementById('detailMessage').innerText = ''; 
        
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    window.saveCustomerDetails = async function() {
        if (!currentEditingUser) return;

        const btn = document.getElementById('saveDetailsBtn');
        const messageElement = document.getElementById('detailMessage');
        
        btn.disabled = true;
        messageElement.style.color = 'var(--info-color)';
        messageElement.innerText = 'Kaydediliyor...';

        try {
            // Bakiye alanƒ±nƒ± float olarak kaydetmek i√ßin parse et
            const newBalance = parseFloat(document.getElementById('detailBalance').value) || 0; 
            
            // Supabase ile Toplu G√ºncelleme
            const { error } = await supabaseClient
                .from('customers')
                .update({
                    site_adi: document.getElementById('detailSiteName').value.trim(),
                    serviceStatus: document.getElementById('detailStatus').value,
                    admin_notes: document.getElementById('detailNotes').value.trim(),
                    balance: newBalance,
                    lastUpdated: new Date().toISOString() // Supabase timestamp formatƒ± (Eƒüer tablonuzda bu isimde s√ºtun yoksa hata verebilir, ama ≈üimdilik bƒ±rakƒ±yorum)
                })
                .eq('user_id', currentEditingUser.userId); // Doƒüru user_id ile e≈üle≈ütir

            if (error) throw error;

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = '‚úÖ Detaylar ba≈üarƒ±yla g√ºncellendi!';
            
            setTimeout(() => {
                document.getElementById('detailModal').style.display = 'none';
                currentEditingUser = null;
            }, 1000);

        } catch (error) {
            console.error("Detaylar kaydedilirken hata olu≈ütu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Hata: ${error.message}`;
        } finally {
            btn.disabled = false;
        }
    }
    
    document.getElementById('closeDetailModalBtn').addEventListener('click', () => {
        document.getElementById('detailModal').style.display = 'none';
        currentEditingUser = null;
    });

    document.getElementById('saveDetailsBtn').addEventListener('click', saveCustomerDetails);

    // ----------------------------------------------------------------------
    // 7. YETKƒ∞LENDƒ∞RME ve BA≈ûLATMA (GE√áƒ∞Cƒ∞ OLARAK G√úVENSƒ∞Z Y√ñNTEM)
    // ----------------------------------------------------------------------

    /**
     * √áƒ±kƒ±≈ü Yapma ƒ∞≈ülemi (≈ûimdilik y√∂nlendirme yapar)
     */
    window.handleLogout = function() {
        showModal("G√úVENSƒ∞Z KULLANIM", "≈ûu anda y√∂netici yetkilendirme sistemi (Auth) devre dƒ±≈üƒ±dƒ±r. √áƒ±kƒ±≈ü yapmak i√ßin login.html sayfasƒ±na y√∂nlendiriliyorsunuz.", 'alert', () => {
             // Supabase Auth entegre edilene kadar y√∂nlendirme yapar
             window.location.href = 'login.html';
        });
    }

    // ‚õîÔ∏è G√ºvenlik Uyarƒ±sƒ±: Firebase Auth kaldƒ±rƒ±ldƒ±ƒüƒ± i√ßin, sayfa a√ßƒ±lƒ±r a√ßƒ±lmaz veri √ßekme ba≈ülatƒ±lƒ±r.
    listenForCustomers();
    listenForRecentActivity(); // Aktivite loglarƒ±nƒ± ba≈ülat
    
    // Duyuru butonunu baƒüla
    document.getElementById('publishAnnouncementBtn').addEventListener('click', publishAnnouncement);
</script>
</body>
</html>
