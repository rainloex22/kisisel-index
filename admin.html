<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli | bakikara.xyz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght(400);700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* TEMA RENKLERÄ° */
        :root {
            --primary-color: #5d3f6a;       /* KapalÄ± Mor Vurgu */
            --bg-dark: #1e1e2d;             /* Koyu Arka Plan */
            --bg-card: #27293d;             /* Koyu Kart Arka PlanÄ± */
            --text-light: #e0e0e0;          /* AÃ§Ä±k Metin */
            --text-secondary: #a9a9b6;      /* Ä°kincil Metin */
            --border-dark: #3b3b51;         /* Koyu SÄ±nÄ±r */
            --danger-color: #e74c3c;        /* KÄ±rmÄ±zÄ± (Sil/Ã‡Ä±kÄ±ÅŸ) */
            --success-color: #28a745;       /* YeÅŸil (YayÄ±nda) */
            --warning-color: #ffc107;       /* SarÄ± (Onay Bekliyor) */
            --info-color: #007bff;          /* Mavi (Dosya Bekleniyor) */
            --suspend-color: #f39c12;       /* Turuncu (AskÄ±da) */
            --passive-color: #7f8c8d;       /* Gri (Pasif) */
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* GENEL STÄ°L */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-light);
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
        }
        .container {
            max-width: 1600px; 
            margin: 0 auto;
            padding: 40px 20px;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        /* KONTROL ALANI VE Ã–ZET KARTLARI */
        .controls-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Ãœst hizalama */
            flex-wrap: wrap; /* KÃ¼Ã§Ã¼k ekranlarda alt alta gelme */
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-group {
            display: flex;
            gap: 20px; 
            flex-wrap: wrap;
        }
        
        .summary-card {
            background-color: var(--bg-card);
            padding: 15px 25px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            border-left: 5px solid var(--primary-color);
            box-shadow: var(--shadow);
            min-width: 180px; 
            transition: transform 0.3s;
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card strong {
            font-size: 1.5em;
            color: var(--primary-color);
        }
        
        .summary-card.active-card { border-left-color: var(--success-color); }
        .summary-card.pending-card { border-left-color: var(--warning-color); }


        /* FÄ°LTRE ALANI */
        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        #statusFilter, #searchFilter {
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        #statusFilter {
            width: 200px;
        }
        #searchFilter {
             width: 300px;
        }


        /* TABLO STÄ°LLERÄ° */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--bg-card);
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
        }
        .admin-table th, .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-dark);
        }
        .admin-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer; 
        }
        .admin-table th .sort-icon {
            margin-left: 5px;
            font-size: 0.7em;
            color: #d1c4e9;
        }
        .admin-table tr:hover td {
            background-color: #2e3046;
        }
        .admin-table td {
            color: var(--text-light);
            font-size: 0.9em;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 100px; 
            text-align: center;
        }
        .status-pending { background-color: var(--warning-color); color: #333; }
        .status-active { background-color: var(--success-color); color: white; }
        .status-file { background-color: var(--info-color); color: white; }
        .status-suspended { background-color: var(--suspend-color); color: white; }
        .status-passive { background-color: var(--passive-color); color: white; }
        .action-btn {
            background-color: var(--info-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s;
        }
        .action-btn:hover {
            opacity: 0.9;
        }
        .action-btn.delete-btn {
            background-color: var(--danger-color);
        }
        .action-btn.detail-btn {
            background-color: #00bcd4;
        }
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 20px;
            right: 20px;
            transition: background-color 0.3s;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        #loading, #error-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        /* DUYURU ALANI STÄ°LLERÄ° */
        .announcement-area {
            margin-top: 40px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .announcement-area h2 {
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }
        #announcementText {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            resize: vertical;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        #publishAnnouncementBtn {
            background-color: var(--primary-color);
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #publishAnnouncementBtn:hover {
            background-color: #7b578c;
        }

        /* AKTÄ°VÄ°TE ALANI STÄ°LLERÄ° */
        .activity-area {
            margin-top: 40px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .activity-area h2 {
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .activity-list li {
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-dark);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-list li:last-child {
            border-bottom: none;
        }
        .activity-meta {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-left: 10px;
            min-width: 120px; /* Tarih/saat iÃ§in yer ayÄ±r */
            text-align: right;
        }
        .activity-text {
            flex-grow: 1;
            text-align: left;
            padding-right: 10px;
        }

        /* MODAL (Ã–zel Pencere) STÄ°LLERÄ° */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* VarsayÄ±lan olarak gizli */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        .modal-input-group label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        .modal-input-group input, .modal-input-group select, .modal-input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive TasarÄ±m */
        @media (max-width: 900px) {
            .controls-area {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .summary-group, .filter-group {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .summary-card {
                width: 100%;
                min-width: unset;
            }
            #statusFilter, #searchFilter {
                 width: 100%;
            }
            .admin-table thead {
                display: none; 
            }
            .admin-table, .admin-table tbody, .admin-table tr, .admin-table td {
                display: block;
                width: 100%;
            }
            .admin-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-dark);
                border-radius: 8px;
            }
            .admin-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: none;
            }
            .admin-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--primary-color);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <button class="logout-btn" onclick="handleLogout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
    <h1><i class="fas fa-user-shield"></i> YÃ¶netici Paneli - MÃ¼ÅŸteriler</h1>

    <div class="controls-area">
        <div class="summary-group">
            <div class="summary-card total-card">
                Toplam MÃ¼ÅŸteri: <strong id="totalCustomers">0</strong>
            </div>
            <div class="summary-card active-card">
                Aktif/YayÄ±nda: <strong id="activeCustomers">0</strong>
            </div>
            <div class="summary-card pending-card">
                Onay Bekleyen: <strong id="pendingCustomers">0</strong>
            </div>
        </div>
        <div class="filter-group">
            <select id="statusFilter" onchange="filterCustomers()">
                 <option value="ALL">TÃ¼m Durumlar</option>
                 <option value="ACTIVE">YAYINDA</option>
                 <option value="PENDING">Onay Bekliyor</option>
                 <option value="SUSPENDED">ASKIYA ALINDI</option>
                 <option value="PASSIVE">PASÄ°F</option>
                 <option value="FILE_WAITING">Dosya Bekleniyor</option>
            </select>
            <input type="text" id="searchFilter" placeholder="E-posta veya kullanÄ±cÄ± adÄ± ile ara..." onkeyup="filterCustomers()">
        </div>
    </div>
    <div class="announcement-area">
        <h2><i class="fas fa-bullhorn"></i> Yeni Duyuru YayÄ±nla</h2>
        <div class="announcement-card">
            <textarea id="announcementText" placeholder="MÃ¼ÅŸterilerinize gÃ¶ndermek istediÄŸiniz duyuru metnini buraya yazÄ±n..." rows="3"></textarea>
            <button id="publishAnnouncementBtn" class="action-btn">Duyuruyu YayÄ±nla</button>
            <p id="announcementMessage" style="margin-top: 10px; color: var(--text-light);"></p>
        </div>
    </div>
    <div id="loading">MÃ¼ÅŸteri verileri yÃ¼kleniyor...</div>
    <div id="error-message" style="display:none;"></div>
    
    <table class="admin-table" id="customerTable" style="display:none;">
        <thead>
            <tr>
                <th onclick="sortCustomers('email')">E-posta / Site AdÄ± <span id="sortEmail" class="sort-icon fas fa-sort"></span></th>
                <th onclick="sortCustomers('created_at')">KayÄ±t Tarihi <span id="sortCreated_at" class="sort-icon fas fa-sort-down"></span></th> 
                <th onclick="sortCustomers('balance')">Bakiye (â‚º) <span id="sortBalance" class="sort-icon fas fa-sort"></span></th>
                <th>Site Adresi (Ã–neri)</th>
                <th onclick="sortCustomers('servicestatus')">Durum <span id="sortServicestatus" class="sort-icon fas fa-sort"></span></th>
                <th>Ä°ÅŸlemler</th>
            </tr>
        </thead>
        <tbody id="customerTableBody">
        </tbody>
    </table>
    <div class="activity-area">
        <h2><i class="fas fa-history"></i> Son YÃ¶netici Aktivitesi (Duyurular)</h2>
        <ul id="announcementList" class="activity-list">
            <li>Aktivite yÃ¼kleniyor...</li>
        </ul>
    </div>
    </div>

<div id="customModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle">Mesaj</h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
            <button id="modalConfirmBtn" class="action-btn" style="background-color: var(--success-color);">Onayla</button>
            <button id="modalCancelBtn" class="action-btn" style="background-color: var(--passive-color);">Kapat</button>
        </div>
    </div>
</div>

<div id="detailModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3><i class="fas fa-edit"></i> MÃ¼ÅŸteri DetaylarÄ±nÄ± DÃ¼zenle</h3>
        <div class="modal-input-group">
            <label for="detailEmail">E-posta:</label>
            <input type="text" id="detailEmail" disabled>
        </div>
        <div class="modal-input-group">
            <label for="detailSiteName">Site AdÄ±:</label>
            <input type="text" id="detailSiteName">
        </div>
        <div class="modal-input-group">
            <label for="detailBalance">Bakiye (â‚º):</label>
            <input type="number" id="detailBalance" step="0.01">
        </div>
        <div class="modal-input-group">
            <label for="detailStatus">Durum:</label>
            <select id="detailStatus">
                <option value="ACTIVE">YAYINDA</option>
                <option value="PENDING">Onay Bekliyor</option>
                <option value="SUSPENDED">ASKIYA ALINDI</option>
                <option value="PASSIVE">PASÄ°F</option>
                <option value="FILE_WAITING">Dosya Bekleniyor</option>
            </select>
        </div>
        <div class="modal-input-group">
            <label for="detailNotes">YÃ¶netici NotlarÄ±:</label>
            <textarea id="detailNotes" rows="3" placeholder="Bu mÃ¼ÅŸteriyle ilgili Ã¶nemli notlarÄ±nÄ±zÄ± buraya yazÄ±n."></textarea>
        </div>
        <p id="detailMessage" style="margin-top: 10px; color: var(--text-light);"></p>
        <div class="modal-buttons">
            <button id="saveDetailsBtn" class="action-btn" style="background-color: var(--primary-color);">Kaydet</button>
            <button id="closeDetailModalBtn" class="action-btn" style="background-color: var(--passive-color);">Ä°ptal</button>
        </div>
    </div>
</div>
<script type="module">
    // ----------------------------------------------------------------------
    // ðŸ”¥ ADIM 1: SUPABASE BAÄžLANTI AYARLARI
    // ----------------------------------------------------------------------
    const SUPABASE_URL = 'https://rqbbxjuncwwgtkbcqtet.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxYmJ4anVuY3d3Z3RrYmNxdGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzM1NjAsImV4cCI6MjA3ODAwOTU2MH0.8dzDoL8MEgbrL7b-ocJ79c9ts9qtSbFT3EashQZXyZQ'; 
    
    // CDN Ã¼zerinden global olarak eklenen Supabase client'Ä± baÅŸlat
    const { createClient } = supabase; 
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { 
            // GeÃ§ici olarak Auth persistSession Ã¶zelliÄŸini kapatÄ±yoruz. 
            // YÃ¶netici giriÅŸi iÃ§in bu kÄ±sÄ±m sonradan Supabase Auth ile deÄŸiÅŸtirilmelidir.
            persistSession: false 
        }
    });

    // ðŸ”¥ DÄ°KKAT: YÃ¶netici KontrolÃ¼ geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸtÄ±r.
    const ADMIN_EMAIL = "mehmeteminacan13@gmail.com"; 
    
    const loading = document.getElementById('loading');
    const table = document.getElementById('customerTable');
    const tableBody = document.getElementById('customerTableBody');
    const errorMessage = document.getElementById('error-message');
    
    const totalCustomersSpan = document.getElementById('totalCustomers');
    const activeCustomersSpan = document.getElementById('activeCustomers');
    const pendingCustomersSpan = document.getElementById('pendingCustomers');
    const announcementList = document.getElementById('announcementList');
    
    let allCustomers = [];
    let currentEditingUser = null; 
    let sortKey = 'created_at'; 
    let sortDirection = 'desc'; 

    // ----------------------------------------------------------------------
    // 1. Ã–ZEL MODAL Ä°ÅžLEVLERÄ° (AynÄ± kaldÄ±)
    // ----------------------------------------------------------------------

    /**
     * Ã–zel bir onay (confirm) veya bildirim (alert) penceresi gÃ¶sterir.
     */
    function showModal(title, message, type = 'alert', callback = () => {}) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        if (type === 'confirm') {
            confirmBtn.style.display = 'inline-block';
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                callback(true); 
            };
            cancelBtn.innerText = 'Ä°ptal';
        } else {
            confirmBtn.style.display = 'none';
            cancelBtn.innerText = 'Kapat';
        }

        cancelBtn.onclick = () => {
            modal.style.display = 'none';
            if (type === 'confirm') {
                 callback(false); 
            }
        };

        modal.style.display = 'flex';
    }


    // ----------------------------------------------------------------------
    // 2. MÃœÅžTERÄ° TABLOSU ve FÄ°LTRE/SIRA Ä°ÅžLEVLERÄ°
    // ----------------------------------------------------------------------
    
    /**
     * MÃ¼ÅŸteri DurumlarÄ± ve Etiket OluÅŸturma Fonksiyonu
     */
    function getStatusBadge(status) {
        let className = 'status-file';
        let text = 'Dosya Bekleniyor';
        
        switch (status) {
            case 'ACTIVE':
                className = 'status-active';
                text = 'YAYINDA';
                break;
            case 'PENDING':
                className = 'status-pending';
                text = 'Onay Bekliyor';
                break;
            case 'SUSPENDED':
                className = 'status-suspended';
                text = 'ASKIYA ALINDI';
                break;
            case 'PASSIVE':
                className = 'status-passive';
                text = 'PASÄ°F';
                break;
            case 'FILE_WAITING':
            default:
                className = 'status-file';
                text = 'Dosya Bekleniyor';
                break;
        }
        return `<span class="status-badge ${className}" data-status="${status}">${text}</span>`;
    }

    /**
     * MÃ¼ÅŸteri verilerini tabloya iÅŸleyen ana render fonksiyonu
     */
    function renderTable(customers) {
        // SÄ±ralama uygula
        customers.sort((a, b) => {
            let aVal = a[sortKey];
            let bVal = b[sortKey];

            // created_at iÃ§in tarih sÄ±ralamasÄ±
            if (sortKey === 'created_at') { 
                aVal = aVal ? new Date(aVal).getTime() : 0;
                bVal = bVal ? new Date(bVal).getTime() : 0;
            }
            // balance iÃ§in sayÄ±sal sÄ±ralama
            if (sortKey === 'balance') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        tableBody.innerHTML = '';

        // SÄ±ralama ikonu gÃ¼ncelleme
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort');
        });
        
        let iconId = '';
        if (sortKey === 'created_at') {
            iconId = 'sortCreated_at';
        // ðŸ”¥ DÃœZELTME: servicestatus iÃ§in Ã¶zel eÅŸleÅŸtirme
        } else if (sortKey === 'servicestatus') {
            iconId = 'sortServicestatus'; 
        } else {
            iconId = `sort${sortKey.charAt(0).toUpperCase() + sortKey.slice(1)}`;
        }
        
        const currentSortIcon = document.getElementById(iconId);
        
        if (currentSortIcon) {
             currentSortIcon.classList.remove('fa-sort');
             currentSortIcon.classList.add(sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
        }

        if (customers.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--warning-color);">Filtreye uyan mÃ¼ÅŸteri bulunamadÄ±.</td></tr>`;
            return;
        }

        customers.forEach(user => {
            const userEmail = user.email || 'Bilinmiyor';
            const username = userEmail.split('@')[0];
            const siteUrl = `bakikara.xyz/${user.site_adi || username}`; 
            const regDate = user.created_at ? new Date(user.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Bilinmiyor';
            // ðŸ”¥ DÃœZELTME: user.servicestatus kullanÄ±lÄ±yor
            const status = user.servicestatus || 'FILE_WAITING'; 
            const balance = (user.balance || 0).toFixed(2); 

            const row = tableBody.insertRow();
            
            row.innerHTML = `
                <td data-label="E-posta / Site AdÄ±">
                    <strong>${userEmail}</strong><br>
                    <span style="color:var(--text-secondary);">${user.site_adi || 'Site AdÄ± Yok'}</span>
                </td>
                <td data-label="KayÄ±t Tarihi">${regDate}</td>
                <td data-label="Bakiye (â‚º)">â‚º ${balance}</td>
                <td data-label="Site Adresi (Ã–neri)"><a href="http://${siteUrl}" target="_blank" style="color:var(--info-color);">${siteUrl}</a></td>
                <td data-label="Durum">${getStatusBadge(status)}</td>
                <td data-label="Ä°ÅŸlemler">
                    <button class="action-btn detail-btn" onclick="window.showCustomerDetailModal('${user.user_id}')"><i class="fas fa-search"></i> Detay/DÃ¼zenle</button>
                    <button class="action-btn open-site-btn" onclick="window.openCustomerSite('${siteUrl}')"><i class="fas fa-external-link-alt"></i> Siteyi AÃ§</button>
                    <button class="action-btn" onclick="window.updateCustomerStatus('${user.user_id}', 'ACTIVE')"><i class="fas fa-check"></i> YayÄ±na Al</button>
                    <button class="action-btn delete-btn" onclick="window.deleteCustomer('${user.user_id}')"><i class="fas fa-trash-alt"></i> Sil</button>
                </td>
            `;
        });
    }

    /**
     * Tablo baÅŸlÄ±ÄŸÄ±na tÄ±klandÄ±ÄŸÄ±nda sÄ±ralama yapar
     */
    window.sortCustomers = function(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortKey = key;
            sortDirection = 'asc'; 
            if (key === 'created_at' || key === 'balance') sortDirection = 'desc'; 
        }
        filterCustomers(); // Veriyi yeniden render et
    }

    /**
     * Arama ve Durum Filtreleme Fonksiyonu
     */
    window.filterCustomers = function() {
        const searchText = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value; 

        const filtered = allCustomers.filter(user => {
            const userEmail = (user.email || '').toLowerCase();
            const username = userEmail.split('@')[0].toLowerCase();
            const siteAdi = (user.site_adi || '').toLowerCase();
            // ðŸ”¥ DÃœZELTME: user.servicestatus kullanÄ±lÄ±yor
            const status = (user.servicestatus || 'FILE_WAITING');
            
            const textMatch = userEmail.includes(searchText) || username.includes(searchText) || siteAdi.includes(searchText);
            const statusMatch = statusFilter === 'ALL' || status === statusFilter;

            return textMatch && statusMatch;
        });

        renderTable(filtered);
    }

    // ----------------------------------------------------------------------
    // 3. GERÃ‡EK ZAMANLI VERÄ° Ã‡EKME (SUPABASE REALTIME)
    // ----------------------------------------------------------------------

    /**
     * Veriyi bir kez Ã§eken ana fonksiyon
     */
    async function fetchAndRenderCustomers() {
        loading.style.display = 'block';

        try {
            const { data: customers, error } = await supabaseClient
                .from('customers') 
                .select('*') 
                .order('created_at', { ascending: false }); 

            if (error) {
                throw error;
            }

            loading.style.display = 'none';
            table.style.display = 'table';
            
            if (!customers || customers.length === 0) {
                loading.innerText = 'HenÃ¼z kayÄ±tlÄ± mÃ¼ÅŸteri bulunmamaktadÄ±r.';
                loading.style.display = 'block';
                allCustomers = [];
                renderTable([]);
                
                totalCustomersSpan.innerText = '0';
                activeCustomersSpan.innerText = '0';
                pendingCustomersSpan.innerText = '0';
                return;
            }

            allCustomers = customers.map(doc => ({
                userId: doc.user_id, 
                ...doc
            }));

            // Ã–zet KartlarÄ± GÃ¼ncelle
            // ðŸ”¥ DÃœZELTME: u.servicestatus kullanÄ±lÄ±yor
            const activeCount = allCustomers.filter(u => u.servicestatus === 'ACTIVE').length;
            const pendingCount = allCustomers.filter(u => u.servicestatus === 'PENDING' || u.servicestatus === 'FILE_WAITING').length; 
            
            totalCustomersSpan.innerText = allCustomers.length;
            activeCustomersSpan.innerText = activeCount;
            pendingCustomersSpan.innerText = pendingCount; 

            filterCustomers();

        } catch (error) {
            console.error("Supabase Veri Ã‡ekme HatasÄ±:", error.message);
            loading.style.display = 'none';
            errorMessage.innerText = `Veri dinleme hatasÄ±: ${error.message}`;
            errorMessage.style.display = 'block';
        }
    }


    /**
     * MÃ¼ÅŸteri Verilerini GerÃ§ek ZamanlÄ± Dinleme ve Ã–zet KartlarÄ± GÃ¼ncelleme
     */
    function listenForCustomers() {
        loading.style.display = 'block';
        table.style.display = 'none';
        errorMessage.style.display = 'none';
        
        const channel = supabaseClient
            .channel('customer_changes') 
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'customers' }, 
                (payload) => {
                    console.log('GerÃ§ek ZamanlÄ± Veri DeÄŸiÅŸikliÄŸi AlgÄ±landÄ±:', payload);
                    fetchAndRenderCustomers();
                }
            )
            .subscribe(); 

        fetchAndRenderCustomers();

        return channel;
    };
    
    /**
     * En son yayÄ±nlanan duyurularÄ± (aktivite) Ã§eker.
     */
    async function listenForRecentActivity() {
        console.log("Aktivite dinleyicisi baÅŸlatÄ±ldÄ±...");
        
        try {
            const { data: announcements, error } = await supabaseClient
                .from('announcements')
                .select('text, created_at') 
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) throw error;
            
            announcementList.innerHTML = ''; 
            
            if (announcements.length === 0) {
                announcementList.innerHTML = `<li><i class="fas fa-info-circle"></i> HenÃ¼z yayÄ±nlanmÄ±ÅŸ bir duyuru yok.</li>`;
                return;
            }

            announcements.forEach(announcement => {
                const date = announcement.created_at ? new Date(announcement.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Bilinmiyor';
                
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="activity-text"><i class="fas fa-bell" style="color:var(--primary-color);"></i> ${announcement.text.substring(0, 70)}${announcement.text.length > 70 ? '...' : ''}</span>
                    <span class="activity-meta">${date}</span>
                `;
                announcementList.appendChild(listItem);
            });

        } catch (error) {
            console.error("Aktivite dinlenirken hata oluÅŸtu:", error);
            announcementList.innerHTML = `<li><i class="fas fa-exclamation-triangle" style="color:var(--danger-color);"></i> Aktivite yÃ¼klenirken hata oluÅŸtu.</li>`;
        }
    }

    // ----------------------------------------------------------------------
    // 4. DUYURU YÃ–NETÄ°MÄ° (SUPABASE INSERT)
    // ----------------------------------------------------------------------

    /**
     * Yeni Duyuru Ekleme Fonksiyonu
     */
    async function publishAnnouncement() {
        const textElement = document.getElementById('announcementText');
        const messageElement = document.getElementById('announcementMessage');
        const btn = document.getElementById('publishAnnouncementBtn');
        
        const announcementText = textElement.value.trim();

        if (announcementText.length < 5) {
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = 'Duyuru metni en az 5 karakter olmalÄ±dÄ±r.';
            return;
        }

        messageElement.innerText = 'YayÄ±nlanÄ±yor...';
        btn.disabled = true;

        try {
            const { error } = await supabaseClient
                .from('announcements') 
                .insert([
                    {
                        text: announcementText,
                        publishedBy: ADMIN_EMAIL 
                    }
                ]);

            if (error) throw error;

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = 'âœ… Duyuru baÅŸarÄ±yla yayÄ±nlandÄ±! (MÃ¼ÅŸteri sitelerinde gÃ¶rÃ¼necek)';
            textElement.value = ''; 
            
            listenForRecentActivity();

        } catch (error) {
            console.error("Duyuru yayÄ±nlanÄ±rken hata oluÅŸtu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Duyuru hatasÄ±: ${error.message}`;
        } finally {
            btn.disabled = false;
            setTimeout(() => messageElement.innerText = '', 5000); 
        }
    }
    
    // ----------------------------------------------------------------------
    // 5. MÃœÅžTERÄ° Ä°ÅžLEM FONKSÄ°YONLARI (SUPABASE UPDATE/DELETE)
    // ----------------------------------------------------------------------

    /**
     * MÃ¼ÅŸteri Durumunu GÃ¼ncelleme
     */
    window.updateCustomerStatus = function(userId, newStatus) {
        let statusText = '';
        if (newStatus === 'ACTIVE') statusText = 'YAYINA AL';
        else if (newStatus === 'SUSPENDED') statusText = 'ASKIYA AL';
        else statusText = newStatus;
        
        showModal(
            "Durum GÃ¼ncelleme",
            `KullanÄ±cÄ± ID: ${userId} durumunu ${statusText} olarak gÃ¼ncellemek istediÄŸinizden emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        const { error } = await supabaseClient
                            .from('customers')
                            // ðŸ”¥ DÃœZELTME: servicestatus kullanÄ±lÄ±yor
                            .update({ servicestatus: newStatus, last_updated: new Date().toISOString() }) 
                            .eq('user_id', userId); 

                        if (error) throw error;

                        showModal("BaÅŸarÄ±lÄ±", `Durum baÅŸarÄ±yla ${statusText} olarak gÃ¼ncellendi.`, 'alert');
                    } catch (error) {
                        console.error("Durum gÃ¼ncellenirken hata oluÅŸtu:", error);
                        showModal("Hata", "Durum gÃ¼ncellenirken bir hata oluÅŸtu: " + error.message, 'alert');
                    }
                }
            }
        );
    }

    /**
     * MÃ¼ÅŸteriyi Silme
     */
    window.deleteCustomer = function(userId) {
        showModal(
            "KalÄ±cÄ± Silme OnayÄ±",
            `DÄ°KKAT! KullanÄ±cÄ± ID: ${userId} kalÄ±cÄ± olarak silinecektir. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        const { error } = await supabaseClient
                            .from('customers')
                            .delete()
                            .eq('user_id', userId); 

                        if (error) throw error;
                            
                        showModal("BaÅŸarÄ±lÄ±", `KullanÄ±cÄ± baÅŸarÄ±yla silindi.`, 'alert');
                    } catch (error) {
                        console.error("KullanÄ±cÄ± silinirken hata oluÅŸtu:", error);
                        showModal("Hata", "KullanÄ±cÄ± silinirken bir hata oluÅŸtu: " + error.message, 'alert');
                    }
                }
            }
        );
    }
    
    /**
     * MÃ¼ÅŸterinin Sitesini AÃ§ma
     */
    window.openCustomerSite = function(siteUrl) {
        window.open(`http://${siteUrl}`, '_blank');
    }

    // ----------------------------------------------------------------------
    // 6. DETAY/DÃœZENLE MODALI Ä°ÅžLEVLERÄ° (SUPABASE UPDATE)
    // ----------------------------------------------------------------------
    
    window.showCustomerDetailModal = function(userId) {
        const user = allCustomers.find(u => u.userId === userId); 
        if (!user) return;

        currentEditingUser = user;
        
        document.getElementById('detailEmail').value = user.email || '';
        document.getElementById('detailSiteName').value = user.site_adi || '';
        document.getElementById('detailBalance').value = (user.balance || 0); 
        // ðŸ”¥ DÃœZELTME: user.servicestatus kullanÄ±lÄ±yor
        document.getElementById('detailStatus').value = user.servicestatus || 'FILE_WAITING';
        document.getElementById('detailNotes').value = user.admin_notes || '';
        document.getElementById('detailMessage').innerText = ''; 
        
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    window.saveCustomerDetails = async function() {
        if (!currentEditingUser) return;

        const btn = document.getElementById('saveDetailsBtn');
        const messageElement = document.getElementById('detailMessage');
        
        btn.disabled = true;
        messageElement.style.color = 'var(--info-color)';
        messageElement.innerText = 'Kaydediliyor...';

        try {
            const newBalance = parseFloat(document.getElementById('detailBalance').value) || 0; 
            
            // Supabase ile Toplu GÃ¼ncelleme
            const { error } = await supabaseClient
                .from('customers')
                .update({
                    site_adi: document.getElementById('detailSiteName').value.trim(),
                    // ðŸ”¥ DÃœZELTME: servicestatus kullanÄ±lÄ±yor
                    servicestatus: document.getElementById('detailStatus').value,
                    admin_notes: document.getElementById('detailNotes').value.trim(),
                    balance: newBalance,
                    last_updated: new Date().toISOString()
                })
                .eq('user_id', currentEditingUser.userId); 

            if (error) throw error;

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = 'âœ… Detaylar baÅŸarÄ±yla gÃ¼ncellendi!';
            
            setTimeout(() => {
                document.getElementById('detailModal').style.display = 'none';
                currentEditingUser = null;
            }, 1000);

        } catch (error) {
            console.error("Detaylar kaydedilirken hata oluÅŸtu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Hata: ${error.message}`;
        } finally {
            btn.disabled = false;
        }
    }
    
    document.getElementById('closeDetailModalBtn').addEventListener('click', () => {
        document.getElementById('detailModal').style.display = 'none';
        currentEditingUser = null;
    });

    document.getElementById('saveDetailsBtn').addEventListener('click', saveCustomerDetails);

    // ----------------------------------------------------------------------
    // 7. YETKÄ°LENDÄ°RME ve BAÅžLATMA
    // ----------------------------------------------------------------------

    /**
     * Ã‡Ä±kÄ±ÅŸ Yapma Ä°ÅŸlemi
     */
    window.handleLogout = function() {
        showModal("GÃœVENSÄ°Z KULLANIM", "Åžu anda yÃ¶netici yetkilendirme sistemi (Auth) devre dÄ±ÅŸÄ±dÄ±r. Ã‡Ä±kÄ±ÅŸ yapmak iÃ§in login.html sayfasÄ±na yÃ¶nlendiriliyorsunuz.", 'alert', () => {
             window.location.href = 'login.html';
        });
    }

    // BaÅŸlangÄ±Ã§ fonksiyonlarÄ±nÄ± Ã§aÄŸÄ±r
    listenForCustomers();
    listenForRecentActivity(); 
    
    document.getElementById('publishAnnouncementBtn').addEventListener('click', publishAnnouncement);
</script>
</body>
</html>
