<script>
    // Bu script, yukarıdaki module script (Firebase hatalarından dolayı) çalışmasa bile body'i görünür yapar.
    document.addEventListener('DOMContentLoaded', () => {
         document.body.style.opacity = '1';
    });
</script>

<script type="module">
    // Firebase v9.6.1 import'ları kaldırıldı, sadece v11.6.1 modülleri kullanılıyor.
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { app } from "./firebase-auth-service.js"; // firebase-auth-service.js dosyanızdaki app objesini içe aktarın

    const auth = getAuth(app);
    const db = getFirestore(app);
    const loggedOutNav = document.getElementById('loggedOutNav');
    const loggedInNav = document.getElementById('loggedInNav');

    function getInitials(name) {
        if (!name) return '??';
        const parts = name.split(' ');
        if (parts.length > 1) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return name[0].toUpperCase();
    }

    /**
     * Header UI'yı kullanıcı oturum durumuna göre günceller.
     */
    async function updateHeaderUI(user) {
        if (loggedOutNav && loggedInNav) {
            if (user && !user.isAnonymous) {
                // 1. KULLANICI GİRİŞ YAPMIŞ DURUMDA
                loggedOutNav.classList.add('hidden');
                loggedInNav.classList.remove('hidden');

                const navDisplayName = document.getElementById('nav_display_name');
                const navUserRole = document.getElementById('nav_user_role');
                const navProfileInitials = document.getElementById('nav_profile_initials');
                
                let displayName = user.displayName || user.email.split('@')[0];
                let accountType = "STANDART"; 
                
                // Firestore'dan Hesap Türünü çek
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        accountType = docSnap.data().accountType || "STANDART";
                    }
                } catch (e) {
                    console.error("Firestore veri çekme hatası:", e);
                }

                // Bilgileri yerleştir
                if (navDisplayName) navDisplayName.textContent = displayName;
                if (navUserRole) navUserRole.textContent = accountType;
                if (navProfileInitials) navProfileInitials.textContent = getInitials(displayName);

            } else {
                // 2. KULLANICI GİRİŞ YAPMAMIŞ DURUMDA
                loggedOutNav.classList.remove('hidden');
                loggedInNav.classList.add('hidden');
            }
        }
    }

    // Çıkış Yapma Fonksiyonu
    async function handleLogout() {
        try {
            await signOut(auth);
            window.location.href = 'girisyap.html'; 
        } catch (error) {
            console.error("Çıkış hatası:", error);
        }
    }

    // --- Oturum Durumu Değişikliği Dinleyicisi ---
    onAuthStateChanged(auth, (user) => {
        updateHeaderUI(user);
    });

    // Logout butonuna olayı bağlama (Dropdown içinde)
    document.getElementById('logoutButtonNav')?.addEventListener('click', handleLogout);

    // --- YARDIM SAYFASINA ÖZEL: Akordiyon (Sıkça Sorulan Sorular) Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.accordion-item').forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.getAttribute('data-target');
                const content = document.getElementById(targetId);
                const icon = item.querySelector('.fa-chevron-down');

                const isCurrentlyHidden = content.classList.contains('hidden');
                
                // Tüm açık olanları kapat ve iconları sıfırla
                document.querySelectorAll('.accordion-item p').forEach(p => p.classList.add('hidden'));
                document.querySelectorAll('.accordion-item i').forEach(i => i.classList.remove('rotate-180'));

                if (isCurrentlyHidden) {
                    // Sadece tıklananı aç
                    content.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                }
            });
        });
        
        // YENİ: Dropdown açma/kapama JS'i
        document.getElementById('profileMenuButton')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (event) => {
            const menu = document.getElementById('loggedInNav');
            const isClickInside = menu?.contains(event.target);
            if (!isClickInside) {
                document.getElementById('profileDropdown')?.classList.add('hidden');
            }
        });
    });

    // Sayfa yüklendiğinde Firebase başlatma ve dinleme işlemini başlat (varsa)
    window.onload = window.startClient;

</script>
